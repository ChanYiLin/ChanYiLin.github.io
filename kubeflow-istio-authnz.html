<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-58777369-2', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
  <title>Kubeflow如何搭配Istio實作Multi-user認證與權限管理(上) | Distributed World</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="昨天提到了透過Kubernetes RBAC與Istio ServiceRole/ServiceRoleBinding來做服務與資源的權限認證，以達成Multi-user情境。今天來說說如何進行認證，以及這個獨立的`AuthService`是什麼。">
<meta name="keywords" content="Kubeflow,Kubeflow v0.7,部署,安裝,Kubernetes,Istio,Multi User">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubeflow如何搭配Istio實作Multi-user認證與權限管理(上)">
<meta property="og:url" content="https://chanyilin.github.io/kubeflow-istio-authnz.html">
<meta property="og:site_name" content="Distributed World">
<meta property="og:description" content="昨天提到了透過Kubernetes RBAC與Istio ServiceRole/ServiceRoleBinding來做服務與資源的權限認證，以達成Multi-user情境。今天來說說如何進行認證，以及這個獨立的`AuthService`是什麼。">
<meta property="og:locale" content="zh-tw">
<meta property="og:image" content="https://i.imgur.com/6kTYwIR.png">
<meta property="og:image" content="https://i.imgur.com/RKJaYRn.png">
<meta property="og:image" content="https://i.imgur.com/pJB7e0T.png">
<meta property="og:image" content="https://i.imgur.com/RKJaYRn.png">
<meta property="og:updated_time" content="2019-12-07T16:26:25.144Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kubeflow如何搭配Istio實作Multi-user認證與權限管理(上)">
<meta name="twitter:description" content="昨天提到了透過Kubernetes RBAC與Istio ServiceRole/ServiceRoleBinding來做服務與資源的權限認證，以達成Multi-user情境。今天來說說如何進行認證，以及這個獨立的`AuthService`是什麼。">
<meta name="twitter:image" content="https://i.imgur.com/6kTYwIR.png">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Distributed World</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://chanyilin.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-kubeflow-istio-authnz" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/kubeflow-istio-authnz.html" class="article-date">
  <time datetime="2019-11-12T08:06:18.000Z" itemprop="datePublished">2019-11-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Kubernetes/">Kubernetes</a>►<a class="article-category-link" href="/categories/Kubernetes/Kubeflow/">Kubeflow</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Kubeflow如何搭配Istio實作Multi-user認證與權限管理(上)
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://i.imgur.com/6kTYwIR.png" alt=""></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>既前一篇分享如何安裝Kubeflow v0.7 Multi-User 版本後，接下來將會詳解其實做原理，因為他的做法非常K8s Native值得大家參考！</p>
<p>原本的Kubeflow各項服務都是獨立的專案，使用方式是分別的操作<code>Jupyter UI</code>來開啟Jupyterhub，或是使用<code>Kubeflow Pipeline UI</code>來創建一個Workflow。這使得整體的使用有些破碎，Kubeflow在接下來的發展將會搭配一個統一的<code>Dashboard UI</code>與認證方案來解決，以下是過去的缺點與將帶來的好處。</p>
<ul>
<li>過去使用者必須對K8s有一定程度的瞭解，甚至在使用Kubeflow服務時，必須用<code>kubectl</code>來操作K8s資源，這提高了Data Scientists使用的門檻。<ul>
<li>接下來的Kubeflow發展將讓使用者更好理解各項服務的資源，將low-level K8s API Resource抽象並近一步定義<strong>high level Kubeflow API</strong>。</li>
</ul>
</li>
<li>過去每一個服務相互獨立，並不方便完成使用者認證與權限管理，使用每一個服務時都必須單獨做認證。<ul>
<li>搭配一個統一的<code>Dashboard UI</code>與<code>Kubeflow API Entry Point</code>，使用者使用服務時只要在<code>Entry Point</code>這一層做認證。</li>
</ul>
</li>
</ul>
<p>而當我們定義了一系列<strong>Kubeflow API Resource</strong>，像是<code>models</code>、<code>trainging dataset</code>、<code>pipelines</code>等。我們就可以在這些資源上自然地執行權限管理。</p>
<h1 id="Kubeflow-Multi-user情境"><a href="#Kubeflow-Multi-user情境" class="headerlink" title="Kubeflow Multi-user情境"></a>Kubeflow Multi-user情境</h1><p>過去除了缺乏一個統一的Kubeflow API Entry Point與Kubeflow API Resource外，<strong>Multi-user</strong>的情境也是大家夢寐以求的。</p>
<p>一個合理的Multi-user情境如下<br><img src="https://i.imgur.com/RKJaYRn.png" alt=""></p>
<p>多個使用者會擁有自己的Kubeflow資源，且與其餘使用者隔離，比方說創建的<code>pipeline</code>或是<code>notebook</code>。<br>同時Kubeflow也提供共享的Group資源，可以讓多個使用者共同分享。</p>
<p>而<strong>Multi-user</strong>、<strong>認證權限管理</strong>與<strong>Kubeflow API Resource</strong>彼此相輔相成，以下開始介紹Kubeflow怎麼提出一個完整的解決方法。</p>
<h1 id="Kubeflow-Kubernetes認證與權限管理"><a href="#Kubeflow-Kubernetes認證與權限管理" class="headerlink" title="Kubeflow/Kubernetes認證與權限管理"></a>Kubeflow/Kubernetes認證與權限管理</h1><p>附圖是認證與權限管理的架構流程圖</p>
<p><img src="https://i.imgur.com/pJB7e0T.png" alt=""></p>
<p>透過一個<code>Kubeflow API Gateway</code>，所有使用Kubeflow服務請求可以在這一層做認證與權限管理。</p>
<p>第一點注意到的是，其實我們需要針對兩種資源與服務做認證與權限，也就是Kubernets原生資源與Kubeflow資源。</p>
<p>舉幾個例子可以讓大家快速了解這兩個資源使用情境。</p>
<ol>
<li><p>對於Kubeflow認證與權限的情境比方說</p>
<ul>
<li>當透過<code>Kubeflow/Jupyterhub UI</code>開一個notebook，首先會透過瀏覽器連到Kubeflow Jupyterhub UI服務，這邊是<strong>Kubeflow層級服務</strong>需要做<strong>使用者認證</strong>來驗證使用者可否用這個服務。</li>
<li>開啟notebook後，哪些帳號可以共同編輯該notebook，甚至在這裏引進group概念，同一個group的成員都可以編輯共享的notebook。</li>
</ul>
</li>
<li><p>對於Kubernetes認證與權限的情境比方說</p>
<ul>
<li>在自己的帳號底下可以列出哪些notebook pod</li>
<li>使用kubctl直接操作Kubernetes資源</li>
</ul>
</li>
</ol>
<p>也因此我們在管理使用者與群組的認證與權限時，必須將Kubeflow服務層級與Kubernetes原生資源整合。</p>
<p>而Kubeflow給出的答案就是使用</p>
<ol>
<li>一個獨立的authservice</li>
<li>Istio/Istio-RBAC</li>
<li>Kubernetes Namespace/RBAC</li>
</ol>
<h1 id="Kubeflow-Profiles-Operator"><a href="#Kubeflow-Profiles-Operator" class="headerlink" title="Kubeflow Profiles Operator"></a>Kubeflow Profiles Operator</h1><p>我們先來看<strong>資源使用權限</strong>如何實作。</p>
<p>Kubeflow使用的是一個 <a href="https://github.com/kubeflow/kubeflow/tree/master/components/profile-controller" target="_blank" rel="noopener">Profile Operator</a> 來管理使用者的資源使用權限。</p>
<p>當在Kubeflow創建一個使用者時，其實是創建了一個<strong>Profile CRD</strong>。同時每一個使用者都會被賦予一個<strong>Namespace</strong>與在該Namespace操作創建資源的<strong>Privilege</strong>。這部分便是透過 <code>Profile-Operator</code>、<code>istio RBAC</code>與<code>K8s RBAC</code>。</p>
<p>我們直接從哪些資源會跟著Profile創建來看。</p>
<h2 id="Profile-CRD"><a href="#Profile-CRD" class="headerlink" title="Profile CRD"></a>Profile CRD</h2><p>一個Profile會包含名稱與信箱，接下來將會實作針對每個使用者的資源限制！<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeflow.org/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Profile</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kubeflow-user1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  owner:</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">User</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">user1@abcd.com</span></span><br><span class="line"><span class="attr">  plugins:</span></span><br><span class="line"><span class="attr">  - kind:</span> <span class="string">WorkloadIdentity</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      gcpServiceAccount:</span> <span class="string">kubeflow2@project-id.iam.gserviceaccount.com</span></span><br><span class="line">  <span class="comment"># resourceQuotaSpec:</span></span><br><span class="line">  <span class="comment">#   hard:</span></span><br><span class="line">  <span class="comment">#     cpu: "10"</span></span><br><span class="line">  <span class="comment">#     memory: 20Gi</span></span><br><span class="line">  <span class="comment">#     pods: "20"</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h2><p>Controller會創建一個與使用者同名的Namespace，並標為<code>istio-enabled</code>以利後面引入<code>Istio</code>做認證與權限管理。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">admin@kubeflow.org</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    istio-injection:</span> <span class="string">enabled</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  finalizers:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line"><span class="attr">  phase:</span> <span class="string">Active</span></span><br></pre></td></tr></table></figure>
<h2 id="Istio-RBAC"><a href="#Istio-RBAC" class="headerlink" title="Istio RBAC"></a>Istio RBAC</h2><p>這部分就是利用Istio來實作權限認證的環節，限制使用者可以連線使用的服務。方法是在該使用者的Namespace底下創建<code>Istio-ServiceRole</code>與<code>Istio-ServiceRoleBinding</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="bullet">-o</span> <span class="string">yaml</span> <span class="string">servicerole/ns-access-istio</span> <span class="bullet">-n</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.istio.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line"><span class="attr">    role:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">admin@kubeflow.org</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ns-access-istio</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - services:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'*'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="bullet">-o</span> <span class="string">yaml</span> <span class="string">servicerolebinding/owner-binding-istio</span> <span class="bullet">-n</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.istio.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line"><span class="attr">    role:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">admin@kubeflow.org</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">owner-binding-istio</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  roleRef:</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">ServiceRole</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">ns-access-istio</span></span><br><span class="line"><span class="attr">  subjects:</span></span><br><span class="line"><span class="attr">  - properties:</span></span><br><span class="line">      <span class="string">request.headers[kubeflow-userid]:</span> <span class="string">admin@kubeflow.org</span></span><br></pre></td></tr></table></figure>
<p>透過<code>Istio-ServiceRole</code>與<code>Istio-ServiceRoleBinding</code>使得只有該使用者有權限可以連線該Namespace底下的服務。可以看到的是這邊如何認知送來的請求是該使用者，檢查的是<code>Header</code>裡面的<code>kubeflow-userid</code>欄位。這個欄位就是在使用者登入後覆寫夾帶的欄位，後面會介紹這部分的環節。</p>
<h2 id="Owner-rbac-permission"><a href="#Owner-rbac-permission" class="headerlink" title="Owner rbac permission"></a>Owner rbac permission</h2><p>剛剛是利用Istio來實作服務的權限管理，接下來是<strong>Kubernetes原生資源</strong>的權限管理，這邊就是用大家比較熟悉的RBAC，也就是<code>ClusterRole</code>與<code>RoleBinding</code>。另外特別需要注意的就是ClusterRole雖然是Cluster scoped的權限，但是當他透過Namespace scoped的<code>RoleBinding</code>綁定到使用者後，就是Namespace scoped的權限。</p>
<p>以下<code>RoleBinding</code>將<strong>admin權限</strong>綁定到<strong>admin</strong>這個user。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line"><span class="attr">    role:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">admin@kubeflow.org</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">namespaceAdmin</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">admin</span> <span class="comment">#Namespace permission</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">admin</span> <span class="comment"># original Kubernetes ClusterRole</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">User</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">admin@kubeflow.org</span></span><br></pre></td></tr></table></figure></p>
<h2 id="ServiceAccount"><a href="#ServiceAccount" class="headerlink" title="ServiceAccount"></a>ServiceAccount</h2><ol>
<li><strong>default-deitor:</strong> 帶有edit權限的<code>ServiceAccount</code>，可以改動<code>Namespace admin</code>底下的所有資源，除了RBAC。用途比方說，Jupyterhub在該Namespace底下的notebook pod就會是綁定這個<code>ServiceAccount</code></li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="bullet">-o</span> <span class="string">yaml</span> <span class="string">serviceaccount/default-editor</span> <span class="bullet">-n</span> <span class="string">admin</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">default-editor</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">admin</span> <span class="comment"># under admin namespace</span></span><br><span class="line"><span class="attr">secrets:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">default-editor-token-qrllp</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="bullet">-o</span> <span class="string">yaml</span> <span class="string">rolebinding/default-editor</span> <span class="bullet">-n</span> <span class="string">admin</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">default-editor</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span> <span class="comment"># Original K8s ClusterRole edit</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">edit</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">default-editor</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">admin</span> <span class="comment"># The Clusterrole is binding with namespace-scoped ServiceAccoun.</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li><strong>default-viewer:</strong> 帶有view權限的<code>ServiceAccount</code>，可以list/get <code>Namespace admin</code>底下的所有資源。</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="bullet">-o</span> <span class="string">yaml</span> <span class="string">serviceaccount/default-viewer</span> <span class="bullet">-n</span> <span class="string">admin</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">default-viewer</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">secrets:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">default-viewer-token-sdr96</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">default-viewer</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">view</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">default-viewer</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">admin</span></span><br></pre></td></tr></table></figure>
<h2 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h2><p>Kubeflow 使用 <code>Profile</code> 來管理使用者，圍繞這個CRD，管理<code>K8s RBAC</code>與<code>Istio RBAC</code>等相關資源來管理<strong>資源使用權限</strong>。</p>
<p>而透過這樣的資源全限管理，我們便可以發展多使用者與群組的功能，回顧一下一開始的情境圖。</p>
<p><img src="https://i.imgur.com/RKJaYRn.png" alt=""></p>
<p>也因此剩下的工作就是如何處理最外面的 <code>Istio Gateway</code>，並進而針對使用者做認證。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://chanyilin.github.io/kubeflow-istio-authnz.html" data-id="ck41d2vwl00083e4pe1iro4hk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Istio/">Istio</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kubeflow/">Kubeflow</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kubernetes/">Kubernetes</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/kubeflow-istio-authnz-2.html" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Kubeflow如何搭配Istio實作Multi-user認證與權限管理(下)
        
      </div>
    </a>
  
  
    <a href="/argo.html" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Argo</div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Jack Lin<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>



<script src="/js/script.js"></script>



  </div>
</body>
</html>