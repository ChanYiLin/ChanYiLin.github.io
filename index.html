<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-tw">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Cloud Computing, Distributed System, Kubernetes, Deep Learning, Jack Lin">










<meta name="description" content="Currently an exchange student in Germany. Kubeflow member and Kubeflow/tf-operator reviewer.">
<meta property="og:type" content="website">
<meta property="og:title" content="Distributed World">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Distributed World">
<meta property="og:description" content="Currently an exchange student in Germany. Kubeflow member and Kubeflow/tf-operator reviewer.">
<meta property="og:locale" content="zh-tw">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Distributed World">
<meta name="twitter:description" content="Currently an exchange student in Germany. Kubeflow member and Kubeflow/tf-operator reviewer.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>Distributed World</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-58777369-2', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-tw">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Distributed World</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            關於
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            標籤
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            分類
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            歸檔
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/07/argo/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jack Lin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Distributed World">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/07/argo/" itemprop="url">Argo</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2019-02-07T01:24:27+01:00">
                2019-02-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubeflow/" itemprop="url" rel="index">
                    <span itemprop="name">Kubeflow</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubeflow/Kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">Kubernetes</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubeflow/Kubernetes/Workflow/" itemprop="url" rel="index">
                    <span itemprop="name">Workflow</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/07/argo/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/07/argo/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/images/argo.png" alt="argo"></p>
<p>Kubeflow 作為一個 Deep Learning service on Kubernetes 的專案，自然面對最大的問題就是如何將一個 DL 中的每一個 phase 串在一起。而眾多 workflow 工具中， Kubeflow 在這邊選擇使用的便是 - <code>Argo</code>。 Kubeflow 不只將 Argo 應用在 pipeline，也應用在它內部的CI/CD上，因此值得我們好好關注。</p>
<p>Argo 是一個基於 CRD 實作的一個 Workflow 工具，協助使用者管理與控制一系列任務的執行，<br>同時提供一個簡潔的UI介面觀看每一個任務的執行狀況、順序、結果與 log。<br>由於 Workflow 本身是一個 CRD，因此建立 workflow 的方法也是透過撰寫一個 yaml 檔，而 Argo 也針對如何描述一個 workflow 提供了許多的規則。</p>
<h2 id="部署Argo"><a href="#部署Argo" class="headerlink" title="部署Argo"></a>部署Argo</h2><p>我們這邊是獨立部署，如果是直接安裝Kubeflow，以下這些components已經安裝完畢，只需另外安裝argo client即可。</p>
<ol>
<li><p>首先下載安裝Argo client<br> Mac:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install argoproj/tap/argo</span><br></pre></td></tr></table></figure>
<p> Linux:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL -o /usr/local/bin/argo https://github.com/argoproj/argo/releases/download/v2.2.1/argo-linux-amd64</span><br><span class="line">chmod +x /usr/local/bin/argo</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下來安裝Argo Controller 與 UI</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns argo</span><br><span class="line">kubectl apply -n argo -f https://raw.githubusercontent.com/argoproj/argo/v2.2.1/manifests/install.yaml</span><br></pre></td></tr></table></figure>
<p> **NOTE: 因為上面的insall.yaml會需要在你的k8s中創建clusterrole。因此如果使用的是GKE，這邊需要特別開通權限。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding YOURNAME-cluster-admin-binding --clusterrole=cluster-admin --user=YOUREMAIL@gmail.com</span><br></pre></td></tr></table></figure>
<p> 安裝好後就會在k8s下面的argo namespace看到以下的components</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">NAME                         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deploy/argo-ui               1         1         1            1           84d</span><br><span class="line">deploy/workflow-controller   1         1         1            1           84d</span><br><span class="line"></span><br><span class="line">NAME                               DESIRED   CURRENT   READY     AGE</span><br><span class="line">rs/argo-ui-65bb8cf7f6              1         1         1         35s</span><br><span class="line">rs/argo-ui-6bb9c4485f              0         0         0         84d</span><br><span class="line">rs/workflow-controller-7f4dd6bd9   0         0         0         84d</span><br><span class="line">rs/workflow-controller-8fb5fb5d5   1         1         1         33s</span><br><span class="line"></span><br><span class="line">NAME                                     READY     STATUS        RESTARTS   AGE</span><br><span class="line">po/argo-ui-65bb8cf7f6-q2r59              1/1       Running       0          35s</span><br><span class="line">po/argo-ui-6bb9c4485f-7v2d5              1/1       Terminating   0          42d</span><br><span class="line">po/workflow-controller-8fb5fb5d5-spq99   1/1       Running       0          33s</span><br><span class="line"></span><br><span class="line">NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">svc/argo-ui   ClusterIP   10.27.255.240   &lt;none&gt;        80/TCP    84d</span><br></pre></td></tr></table></figure>
</li>
<li><p>在接下來使用Argo的過程中，default account的權限會限制一些功能，因此我們這邊在default account綁上admin privileges。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create rolebinding default-admin --clusterrole=admin --serviceaccount=default:default</span><br></pre></td></tr></table></figure>
<p> 也可以在執行的workflow時指定使用的是哪一個service account</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">argo submit --serviceaccount &lt;name&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>以上即完成Argo的部署。</p>
<h2 id="使用Argo-UI"><a href="#使用Argo-UI" class="headerlink" title="使用Argo UI"></a>使用Argo UI</h2><p>Argo UI 可以讓使用者輕鬆關觀察一個 workflow 的狀況，並檢查每一個步驟的結果與錯誤訊息。</p>
<p><strong>kubectl port-forward</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n argo port-forward deployment/argo-ui 8001:8001</span><br></pre></td></tr></table></figure></p>
<p>透過 <a href="http://127.0.0.1:8001" target="_blank" rel="noopener">http://127.0.0.1:8001</a> 使用</p>
<p><strong>Method 2: kubectl proxy</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy</span><br></pre></td></tr></table></figure></p>
<p>透過  <a href="http://127.0.0.1:8001/api/v1/namespaces/argo/services/argo-ui/proxy/" target="_blank" rel="noopener">http://127.0.0.1:8001/api/v1/namespaces/argo/services/argo-ui/proxy/</a> 使用</p>
<p><strong>Expose a LoadBalancer</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch svc argo-ui -n argo -p &apos;&#123;&quot;spec&quot;: &#123;&quot;type&quot;: &quot;LoadBalancer&quot;&#125;&#125;&apos;</span><br><span class="line"></span><br><span class="line">kubectl get svc argo-ui -n argo</span><br><span class="line">NAME      TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)        AGE</span><br><span class="line">argo-ui   LoadBalancer   10.19.255.205   35.197.49.167   80:30999/TCP   1m</span><br></pre></td></tr></table></figure></p>
<p>結果如下圖：</p>
<p><img src="/images/argo-ui.png" alt="argo-ui"></p>
<h2 id="Argo-範例與解析"><a href="#Argo-範例與解析" class="headerlink" title="Argo 範例與解析"></a>Argo 範例與解析</h2><p>如同上面所說，Argo 也是透過自己實作一個 operator(CRD + controller) 來完成 Workflow 的功能。而所謂的在 k8s 中執行 workflow 的意思便是利用一個個 pod 來執行我們的每一個步驟。</p>
<p>因此我們這邊先來看幾個簡單的 argo crd，看看我們能設定哪些參數及能做到哪些事情。</p>
<p>首先提供一些常用的指令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">argo list #查看有哪些 workflow</span><br><span class="line">argo get xxx-workflow-name-xxx #查看這個 workflow 的狀態</span><br><span class="line">argo logs xxx-pod-name-xxx #查看這個 pod 的 output</span><br></pre></td></tr></table></figure></p>
<h3 id="coinflip"><a href="#coinflip" class="headerlink" title="coinflip"></a>coinflip</h3><p>這個範例的目標是，先丟一個硬幣，如果是 head 就執行 head 的工作，如果是 tail 就執行 tail 的工作。也就是 workflow 最基礎的 if-else 功能。</p>
<p>首先先利用以下指令來執行coinflip worklow：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">argo submit --watch https://raw.githubusercontent.com/argoproj/argo/master/examples/coinflip.yaml</span><br></pre></td></tr></table></figure></p>
<p>接著我們來分析中間發生了哪些事：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Name:                coinflip-czw7h</span><br><span class="line">Namespace:           default</span><br><span class="line">ServiceAccount:      default</span><br><span class="line">Status:              Succeeded</span><br><span class="line">Created:             Wed Feb 06 23:07:02 +0100 (38 seconds ago)</span><br><span class="line">Started:             Wed Feb 06 23:07:02 +0100 (38 seconds ago)</span><br><span class="line">Finished:            Wed Feb 06 23:07:40 +0100 (now)</span><br><span class="line">Duration:            38 seconds</span><br><span class="line"></span><br><span class="line">STEP               PODNAME                    DURATION  MESSAGE</span><br><span class="line"> ✔ coinflip-czw7h</span><br><span class="line"> ├---✔ flip-coin   coinflip-czw7h-3048772414  23s</span><br><span class="line"> └-·-○ heads                                            when &apos;tails == heads&apos; evaluated false</span><br><span class="line">   └-✔ tails       coinflip-czw7h-3790732747  13s</span><br></pre></td></tr></table></figure>
<p>這是你會看到的介面。上面呈現了一些基本的訊息，以及這個 workflow 每一個 steps 發生的事情與執行了哪個相對應得 pod。</p>
<p>因此問題便是，我們如何讓每一個 pod 知道上一步驟的結果，與如何傳遞結果給下一個步驟。</p>
<p>我們現在來細看這個coinflips到底怎麼做的，以下是他的yaml file：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: Workflow</span><br><span class="line">metadata:</span><br><span class="line">  generateName: coinflip-</span><br><span class="line">spec:</span><br><span class="line">  entrypoint: coinflip</span><br><span class="line">  templates:</span><br><span class="line">  - name: coinflip</span><br><span class="line">    steps:</span><br><span class="line">    - - name: flip-coin</span><br><span class="line">        template: flip-coin</span><br><span class="line">    - - name: heads</span><br><span class="line">        template: heads</span><br><span class="line">        when: &quot;&#123;&#123;steps.flip-coin.outputs.result&#125;&#125; == heads&quot;</span><br><span class="line">      - name: tails</span><br><span class="line">        template: tails</span><br><span class="line">        when: &quot;&#123;&#123;steps.flip-coin.outputs.result&#125;&#125; == tails&quot;</span><br><span class="line"></span><br><span class="line">  - name: flip-coin</span><br><span class="line">    script:</span><br><span class="line">      image: python:alpine3.6</span><br><span class="line">      command: [python]</span><br><span class="line">      source: |</span><br><span class="line">        import random</span><br><span class="line">        result = &quot;heads&quot; if random.randint(0,1) == 0 else &quot;tails&quot;</span><br><span class="line">        print(result)</span><br><span class="line"></span><br><span class="line">  - name: heads</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.6</span><br><span class="line">      command: [sh, -c]</span><br><span class="line">      args: [&quot;echo \&quot;it was heads\&quot;&quot;]</span><br><span class="line"></span><br><span class="line">  - name: tails</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.6</span><br><span class="line">      command: [sh, -c]</span><br><span class="line">      args: [&quot;echo \&quot;it was tails\&quot;&quot;]</span><br></pre></td></tr></table></figure>
<p>從上面可以很簡單知道：</p>
<ul>
<li><code>apiVersion: argoproj.io/v1alpha1</code> 與 <code>kind: Workflow</code> 說明了這是一個CRD</li>
<li><code>spec</code> 從 <code>entrypoing</code> 開始執行，在這邊即是從 <code>coinflip</code> 這個 <code>template</code> 開始</li>
<li><code>templates</code> 裡面的每一項描述的都是一個工作，包含<ul>
<li>名字</li>
<li>可以執行一個 <code>container</code> 或是執行 <code>script</code></li>
<li>container <code>image</code></li>
<li><code>command</code> 與 <code>args</code></li>
<li><code>steps</code> : 作用是排定一系列 <code>templates</code> 執行的先後順序</li>
</ul>
</li>
<li>coinflip 同時作為一個 <code>entrypoint</code> ，特別可以看到他裡面描述的是 <code>steps</code> ，且包含：<ul>
<li>每一步驟的名字</li>
<li>要執行的 <code>template</code></li>
<li>什麼時候執行</li>
</ul>
</li>
</ul>
<p>將上面的 yaml 轉成 json 可以視為[[flip-coin], [heads, tails]]，因此會先執行 flip-coin。而 flip-coin 透過執行的 <code>script</code> 會有一個 result 作為 output，表示擲出硬幣的結果。<br>而下面的步驟透過 <code>NaN</code> 來獲得特定步驟的 output 作為判斷的依據，進而可以達成 if-else 的workflow效果 。</p>
<p>Ref: 可另外參考 <a href="https://raw.githubusercontent.com/argoproj/argo/master/examples/coinflip-recursive.yaml" target="_blank" rel="noopener">coinflip-recursive</a></p>
<h3 id="dag-diamond"><a href="#dag-diamond" class="headerlink" title="dag-diamond"></a>dag-diamond</h3><p>在一個 workflow 中除了 <code>if-else</code> 外，有時也需要能夠表達工作之間的相依性，或是有時一些工作需要可以平行執行。而 Argo 便提供 <code>dag</code> 來描述工作的相依性，直接看範例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: Workflow</span><br><span class="line">metadata:</span><br><span class="line">  generateName: dag-diamond-</span><br><span class="line">spec:</span><br><span class="line">  entrypoint: diamond</span><br><span class="line">  templates:</span><br><span class="line">  - name: diamond</span><br><span class="line">    dag:</span><br><span class="line">      tasks:</span><br><span class="line">      - name: A</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: A&#125;]</span><br><span class="line">      - name: B</span><br><span class="line">        dependencies: [A]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: B&#125;]</span><br><span class="line">      - name: C</span><br><span class="line">        dependencies: [A]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: C&#125;]</span><br><span class="line">      - name: D</span><br><span class="line">        dependencies: [B, C]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: D&#125;]</span><br><span class="line"></span><br><span class="line">  - name: echo</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">      - name: message</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.7</span><br><span class="line">      command: [echo, &quot;&#123;&#123;inputs.parameters.message&#125;&#125;&quot;]</span><br></pre></td></tr></table></figure>
<p>可以注意到這邊沒有使用<code>steps</code>，而是使用<code>dag</code>。在<code>dag</code>中的每一項步驟皆可以使用<code>dependencies</code>來描述相依的工作，比方說 B,C 步驟便強迫要在 A 完成後才能執行。而當 A 完成後，B,C 滿足條件便會同時（平行）執行，最後才交由 D 執行。</p>
<p>透過 <code>dag</code> 便可以編排出工作的順序與相依性，或是讓工作平行執行。</p>
<h4 id="dag-與-steps"><a href="#dag-與-steps" class="headerlink" title="dag 與 steps"></a>dag 與 steps</h4><p>還記得剛剛的 flip-coin 範例嗎，透過steps也可以達成某程度的平行執行或是順序執行，但是無法表達相依性。什麼意思呢？</p>
<p>熟悉 yaml 的人應該會知道 yaml 跟 json 是等價可以互相轉換的，而 yaml 中的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">steps:</span><br><span class="line">    - - name: flip-coin</span><br><span class="line">        template: flip-coin</span><br><span class="line">    - - name: heads</span><br><span class="line">        template: heads</span><br><span class="line">        when: &quot;&#123;&#123;steps.flip-coin.outputs.result&#125;&#125; == heads&quot;</span><br><span class="line">      - name: tails</span><br><span class="line">        template: tails</span><br><span class="line">        when: &quot;&#123;&#123;steps.flip-coin.outputs.result&#125;&#125; == tails&quot;</span><br></pre></td></tr></table></figure>
<p>中間的 <code>- -</code> 表達的是 <em>list中的list</em> 的意思，也就是 [[flip-coin], [heads, tails]]。當 steps 再寫的時候如果是依序執行一律用<code>- -</code>，若是在同一個 list 內則會平行執行。</p>
<p>因此以下用一個例子比較：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  entrypoint: diamond</span><br><span class="line">  templates:</span><br><span class="line">  - name: diamond</span><br><span class="line">    steps:</span><br><span class="line">    - - name: A</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: A&#125;]</span><br><span class="line">    - - name: B</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: B&#125;]</span><br><span class="line">      - name: C</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: C&#125;]</span><br><span class="line">    - - name: D</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: D&#125;]</span><br><span class="line"></span><br><span class="line">  - name: echo</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">      - name: message</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.7</span><br><span class="line">      command: [echo, &quot;&#123;&#123;inputs.parameters.message&#125;&#125;&quot;]</span><br></pre></td></tr></table></figure></p>
<p>是等價於<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  entrypoint: diamond</span><br><span class="line">  templates:</span><br><span class="line">  - name: diamond</span><br><span class="line">    dag:</span><br><span class="line">      tasks:</span><br><span class="line">      - name: A</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: A&#125;]</span><br><span class="line">      - name: B</span><br><span class="line">        dependencies: [A]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: B&#125;]</span><br><span class="line">      - name: C</span><br><span class="line">        dependencies: [A]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: C&#125;]</span><br><span class="line">      - name: D</span><br><span class="line">        dependencies: [B, C]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: D&#125;]</span><br><span class="line"></span><br><span class="line">  - name: echo</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">      - name: message</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.7</span><br><span class="line">      command: [echo, &quot;&#123;&#123;inputs.parameters.message&#125;&#125;&quot;]</span><br></pre></td></tr></table></figure></p>
<p>如下圖透過UI看到的結果：</p>
<p><img src="/images/dag-steps-cmp.png" alt="dag-steps-cmp"></p>
<h3 id="conditionals"><a href="#conditionals" class="headerlink" title="conditionals"></a>conditionals</h3><p>了解了上面如何實現 <code>if-else</code> ,<code>依序執行</code>, <code>同時執行</code>後，最後在看一個範例解釋了如何在 workflow 執行時動態的給予參數，並影響結果，我們直接看yaml file：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: Workflow</span><br><span class="line">metadata:</span><br><span class="line">  generateName: conditional-</span><br><span class="line">spec:</span><br><span class="line">  entrypoint: conditional-example</span><br><span class="line">  arguments:</span><br><span class="line">    parameters:</span><br><span class="line">    - name: should-print</span><br><span class="line">      value: &quot;false&quot;</span><br><span class="line"></span><br><span class="line">  templates:</span><br><span class="line">  - name: conditional-example</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">      - name: should-print</span><br><span class="line">    steps:</span><br><span class="line">    - - name: print-hello</span><br><span class="line">        template: whalesay</span><br><span class="line">        when: &quot;&#123;&#123;inputs.parameters.should-print&#125;&#125; == true&quot;</span><br><span class="line"></span><br><span class="line">  - name: whalesay</span><br><span class="line">    container:</span><br><span class="line">      image: docker/whalesay:latest</span><br><span class="line">      command: [sh, -c]</span><br><span class="line">      args: [&quot;cowsay hello&quot;]</span><br></pre></td></tr></table></figure>
<p>在 <code>spec</code> 中可以提供 <code>arguments</code> ，來將參數傳進各個<code>step</code> 中。如上面的範例，預設的參數 <code>should-print</code> 為 “false” 而使得直接執行不會執行 whalesay 步驟，但是在執行 workflow 時使用如下指令，便可以動態傳進參數:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">argo submit examples/conditionals.yaml -p should-print=true</span><br></pre></td></tr></table></figure>
<p>而 <code>step</code> 可以使用 <code>NaN</code> 來獲取參數，whalesay這個步驟便會執行。</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>以上便是 Argo 的簡易使用分享，想了解更詳細的使用方法建議直接參考 <a href="https://github.com/argoproj/argo/tree/master/examples" target="_blank" rel="noopener">example</a> 來找到最適合自己的範例。<br>透過 Argo 我們便可以描述 pod 跟 pod 之間的執行順序關係，還可以在彼此之間傳遞結果。<br>因此 <a href="https://github.com/kubeflow/pipelines" target="_blank" rel="noopener">Kubeflow/pipeline</a> 甚至是 Kubeflow 社群的 CI/CD 皆是利用 Argo來完成的。</p>
<p>接下來會利用我自己為 <a href="https://github.com/kubeflow/tf-operator" target="_blank" rel="noopener">Kubeflow/tf-operator</a> 貢獻的 <a href="https://github.com/kubeflow/tf-operator/commit/2788b4d245be919a22b63383441059fc8405ba4e" target="_blank" rel="noopener">e2e test </a> 來描述 Kubeflow 如何用 Argo 實作自己的 CI/CD。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/15/OpenStack-oslo-config/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jack Lin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Distributed World">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/15/OpenStack-oslo-config/" itemprop="url">OpenStack_oslo_config</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2018-11-15T01:37:25+01:00">
                2018-11-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenStack/" itemprop="url" rel="index">
                    <span itemprop="name">OpenStack</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenStack/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/15/OpenStack-oslo-config/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/15/OpenStack-oslo-config/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="OpenStack-Oslo-–-oslo-config"><a href="#OpenStack-Oslo-–-oslo-config" class="headerlink" title="OpenStack Oslo – oslo.config"></a>OpenStack Oslo – oslo.config</h1><hr>
<p>在學習Python的過程中，寫的程式通常是小型的、獨立的、一次性且不牽涉到系統的。<br>但是當我們希望可以寫一個長時間執行的service或是agent。他們是有能力週期性執行任務，並且提供配置文件供使用者客製化設定，甚至可以產生log訊息讓使用者了解程式目前狀況，通常會不知道如何下手。<br>還好我們不必自己摸索，透過Open Source項目我們可以看到世界級的系統軟體是如何被實現的，而裡面通常也有我們要的答案。</p>
<h1 id="什麼是Oslo項目"><a href="#什麼是Oslo項目" class="headerlink" title="什麼是Oslo項目"></a>什麼是Oslo項目</h1><p>在深入了解OpenStack的實作過程中，經常能夠看到程式中import了帶有oslo字樣的模組。<br>是什麼樣的模組可以在OpenStack中每一個服務的實作都會用到呢？<br>這些模組跟Oslo這個項目又有什麼關係？</p>
<p>我們來看看Oslo這個項目的Mission Statement：</p>
<blockquote>
<p>To produce a set of python libraries containing code shared by OpenStack projects. The APIs provided by these libraries should be high quality, stable, consistent, documented and generally applicable.</p>
</blockquote>
<p>也就是說，Oslo這個項目的起源是因為來自世界各地開發OpenStack的大神們，也無法忍受開發過程中不斷的重複製造輪子。<br>特別將經常使用的功能寫成一系列的模組，整合起來成為一個OpenStack中各服務都共享的項目，並且講求質量、穩定度、一致性、擁有完整的文件，最後就是可以廣泛使用。<br>而這一系列的模組，有些如<code>oslo_config</code>可以用來處理命令行參數和配置文件，或是如<code>oslo_service</code>提供了一個開發者創建新的long-running services的框架。</p>
<p>而這也是這一系列文章的目的，我們也許可以透過學習世界級的軟體，來實現心目中想達成的功能，而且最重要的是 — 我們也不用重複製造輪子!</p>
<h1 id="oslo-config"><a href="#oslo-config" class="headerlink" title="oslo_config"></a>oslo_config</h1><p>通常一個大型的系統，為了滿足使用者在不同情境下的需求，會提供許多可以讓使用者更改的配置選項 (Options)。<br>而這些配置選項值的來源有些是從<strong>命令行參數</strong>、有些是來自於一個包含所有配置選項的<strong>配置文件</strong><br>理所當然程式中便需要一個模組來專門處理數量眾多且來源不同的配置選項。而這任務就是交由oslo_config這個模組負責。<br>根據OpenStack Wiki關於oslo_config的說明，該模組負責以下四個任務</p>
<ol>
<li>command line option parsing</li>
<li>common command line options</li>
<li>configuration file parsing</li>
<li>option value lookup</li>
</ol>
<p>透過oslo_config這個模組，我們將有能力從命令行中直接設定配置選項或是從設定檔中讀取配置選項的值。<br>以下我們直接透過實作來瞭解如何使用oslo_config。</p>
<h1 id="環境安裝"><a href="#環境安裝" class="headerlink" title="環境安裝"></a>環境安裝</h1><p>首先，利用virtualenv來創造一個獨立的環境，並安裝oslo_config<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ pip install virtualenv</span><br><span class="line">$ virtualenv example</span><br><span class="line">$ <span class="built_in">cd</span> example</span><br><span class="line">$ <span class="built_in">source</span> bin/activate</span><br><span class="line">$ pip install oslo.config</span><br></pre></td></tr></table></figure></p>
<h1 id="oslo-config使用"><a href="#oslo-config使用" class="headerlink" title="oslo_config使用"></a>oslo_config使用</h1><p>假設一個使用情境，我們今天希望能夠寫一個程式能夠週期性得執行任務，例如：定期對網頁或另一個服務發送請求。這時我們便希望這個程式可以自由設定以下的配置選項：<br>(1).是否執行週期性任務 (2).週期 (3).目標網址 (4).個人帳號 (5).個人密碼<br>那要如何使用oslo_config來幫我們達到這樣的使用情境呢？</p>
<h2 id="配置選項定義"><a href="#配置選項定義" class="headerlink" title="配置選項定義"></a>配置選項定義</h2><p>每一個配置選項有其名稱和對應的值。<br>而oslo_config的配置選項支援以下幾種型態：<br><code>strings</code>, <code>integers</code>, <code>floats</code>, <code>booleans</code>, <code>lists</code>, <code>‘multi strings’</code> ,  <code>‘key/value pairs’ (dictionary)</code></p>
<p>由於配置選項數量龐大，所以勢必要根據他們的性質或是用途來做<strong>分組</strong>，才能讓使用者快速找到他們需要更改的配置選項。<br>我們先將上面五個配置選項分成兩組，分別是periodic_task與request_api，來看oslo_config如何處理。<br>首先我們先創建如下的資目錄結構。<br><em>注： 不在自訂組別內的會被歸類到DEAULT組</em></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">conf</span><br><span class="line">|_  __init__.py</span><br><span class="line">|_  periodic_conf.py //處理 (1)是否執行週期性任務 (2)週期配置</span><br><span class="line">|_  request_conf.py  //處理 (3)目標網址 (4)帳號 (5)密碼</span><br><span class="line">your_app.py</span><br><span class="line">your_app.conf        //配置文件</span><br></pre></td></tr></table></figure>
<p>接下來先從<code>period_conf.py</code>開始看<br>period_conf.py：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> oslo_config <span class="keyword">import</span> cfg</span><br><span class="line"></span><br><span class="line">opt_periodic_task_group = cfg.OptGroup(name=<span class="string">'periodic_task'</span>,</span><br><span class="line">                                       title=<span class="string">'Periodic Tasks Options'</span>)</span><br><span class="line"></span><br><span class="line">periodic_task_opts = [</span><br><span class="line">    cfg.BoolOpt(<span class="string">'periodic_enable'</span>,</span><br><span class="line">                default=<span class="keyword">True</span>,</span><br><span class="line">                help=<span class="string">'Enable periodic tasks.'</span>),</span><br><span class="line"></span><br><span class="line">    cfg.IntOpt(<span class="string">'periodic_interval'</span>,</span><br><span class="line">                default=<span class="number">60</span>,</span><br><span class="line">                help=<span class="string">'Max interval size between periodic tasks'</span></span><br><span class="line">                     <span class="string">'execution in seconds.'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>首先我們需要先從oslo_config中引入cfg模組，<br>並且透過cfg.OptGroup函式來定義一個配置選項組opt_periodic_task_group，<br>同時給予name與title。</p>
<p>接下來，我們定義兩個配置選項並包在一個名為periodic_task_opts的list中，分別是<br>periodic_enable、periodic_interval。<br>這邊可以看到透過cfg.BoolOpt等函式我們可以設定該配置選項的名稱、預設值、提示…等。<br>其他變數類型也有相對應的函式。</p>
<h2 id="註冊配置選項"><a href="#註冊配置選項" class="headerlink" title="註冊配置選項"></a>註冊配置選項</h2><p>period_conf.py：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_opts</span><span class="params">(conf)</span>:</span></span><br><span class="line">    conf.register_group(opt_periodic_task_group)</span><br><span class="line"></span><br><span class="line">    conf.register_cli_opts(periodic_task_opts,opt_periodic_task_group)</span><br><span class="line">    conf.register_opts(periodic_task_opts, opt_periodic_task_group)</span><br></pre></td></tr></table></figure></p>
<p>延續上面的程式碼，在<code>period_conf.py</code>中寫一個register_opts的函式，負責將我們的配置選項註冊到conf變數中，這邊可以看到有三種函式：</p>
<ul>
<li>register_group: 第一步驟是將group的定義註冊。</li>
<li>register_cli_opts: 如果希望能夠在命令行設定配置參數，則利用此函式註冊配置選項</li>
<li>register_opts: 若是希望透過配置文件來設定參數，則利用此函式註冊配置選項。</li>
</ul>
<p>最後，我們需要再寫一個<code>__init__.py</code>，目的是讓<code>conf</code>這個資料被做為一個模組，並且在裡面將所有不同組別的配置選項做統一的註冊。<br>下面附上<code>__init__.py</code>、<code>period_conf.py</code>、<code>request_conf.py</code>完整程式碼。</p>
<p>＿init＿.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> oslo_config <span class="keyword">import</span> cfg</span><br><span class="line"><span class="keyword">import</span> period_conf</span><br><span class="line"><span class="keyword">import</span> request_conf</span><br><span class="line"></span><br><span class="line">CONF = cfg.CONF</span><br><span class="line"></span><br><span class="line">period_conf.register_opts(CONF)</span><br><span class="line">request_conf.register_opts(CONF)</span><br></pre></td></tr></table></figure></p>
<p>period_conf.py：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> oslo_config <span class="keyword">import</span> cfg</span><br><span class="line"></span><br><span class="line">opt_periodic_task_group = cfg.OptGroup(name=<span class="string">'periodic_task'</span>,</span><br><span class="line">                                       title=<span class="string">'Periodic Tasks Options'</span>)</span><br><span class="line">                                       </span><br><span class="line">periodic_task_opts = [</span><br><span class="line">    cfg.BoolOpt(<span class="string">'periodic_enable'</span>,</span><br><span class="line">                default=<span class="keyword">True</span>,</span><br><span class="line">                help=<span class="string">'Enable periodic tasks.'</span>),</span><br><span class="line"></span><br><span class="line">    cfg.IntOpt(<span class="string">'periodic_interval'</span>,</span><br><span class="line">                default=<span class="number">60</span>,</span><br><span class="line">                help=<span class="string">'Max interval size between periodic tasks'</span></span><br><span class="line">                     <span class="string">'execution in seconds.'</span>),</span><br><span class="line">]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_opts</span><span class="params">(conf)</span>:</span></span><br><span class="line">    conf.register_group(opt_periodic_task_group)</span><br><span class="line"></span><br><span class="line">    conf.register_cli_opts(periodic_task_opts,opt_periodic_task_group)</span><br><span class="line">    conf.register_opts(periodic_task_opts, opt_periodic_task_group)</span><br></pre></td></tr></table></figure></p>
<p>request_conf.py：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> oslo_config <span class="keyword">import</span> cfg</span><br><span class="line"></span><br><span class="line">opt_request_api_group = cfg.OptGroup(name=<span class="string">'request_api'</span>,</span><br><span class="line">                                     title=<span class="string">'Request Api Options'</span>)</span><br><span class="line">                                     </span><br><span class="line">request_api_opts = [</span><br><span class="line">    cfg.StrOpt(<span class="string">'host'</span>,</span><br><span class="line">               default=<span class="string">'localhost'</span>,</span><br><span class="line">               help=<span class="string">'IP/hostname'</span>),</span><br><span class="line"></span><br><span class="line">    cfg.ListOpt(<span class="string">'username'</span>,</span><br><span class="line">                default=<span class="keyword">None</span>,</span><br><span class="line">                help=<span class="string">'A list of usernames'</span>),</span><br><span class="line"></span><br><span class="line">    cfg.DictOpt(<span class="string">'password'</span>,</span><br><span class="line">                default=<span class="keyword">None</span>,</span><br><span class="line">                help=<span class="string">'password for each usernames'</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_opts</span><span class="params">(conf)</span>:</span></span><br><span class="line">    conf.register_group(opt_request_api_group)</span><br><span class="line">    conf.register_opts(request_api_opts, opt_request_api_group</span><br></pre></td></tr></table></figure></p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>現在讓我們看一下配置文件內部的格式<br>your_app.conf:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[request_api]</span><br><span class="line">host = localhost                    //strings</span><br><span class="line">username = Jack, John               //lists</span><br><span class="line">password = Jack: XXXX, John: YYYY   //dictionary</span><br><span class="line"></span><br><span class="line">[periodic_task]</span><br><span class="line">periodic_enable = False             //booleans</span><br><span class="line">periodic_interval = 20              //integers</span><br></pre></td></tr></table></figure></p>
<p>還記得我們剛剛在宣告組別的時候給了name嗎?<br>當時定義的name在配置文件中就是用來表示不同的group。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>終於來到最後在我們自己的程式中取用這些配置的參數。<br>your_app.py:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> conf  //將我們的conf資料夾作為模組<span class="keyword">import</span></span><br><span class="line"><span class="keyword">import</span> sys   </span><br><span class="line"></span><br><span class="line">CONF = conf.CONF</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    CONF(sys.argv[<span class="number">1</span>:], project=<span class="string">'your_app'</span>)</span><br><span class="line"></span><br><span class="line">    print( CONF.request_api.host )</span><br><span class="line">    print( CONF.request_api.username[<span class="number">0</span>])</span><br><span class="line">    print( CONF.request_api.password[<span class="string">'Jack'</span>] )</span><br><span class="line"></span><br><span class="line">    print( CONF.periodic_task.periodic_enable )</span><br><span class="line">    print( CONF.periodic_task.periodic_interval )</span><br></pre></td></tr></table></figure></p>
<p>首先這邊有幾個重點：</p>
<ol>
<li><p>可以看到CONF以全域變數的角色存在，這點在OpenStack community是一個爭執很久的議題。有興趣的可以至下面連結看開發者們的結論。<br><a href="https://wiki.openstack.org/wiki/Oslo#Why_does_oslo.config_have_a_CONF_object.3F_Global_object_SUCK.21" target="_blank" rel="noopener">Why does oslo.config have a CONF object? Global object SUCK!</a></p>
</li>
<li><p>CONF透過命令行參數來找到配置文件位置，那第一行為什麼需要<code>project=&#39;your_app&#39;</code>呢？<br>這是因為在oslo_config設計中，如果沒有指定參數的話，預設會到<code>/etc/project</code>來尋找配置文件。以這邊的例子來說就會至<code>/etc/your_app/</code>底下尋找。</p>
</li>
</ol>
<p>最後執行<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python your_app.py --config-file your_app.conf</span><br></pre></td></tr></table></figure></p>
<p>即可看到你在配置文件中配置的參數。</p>
<p>等等，那如果我希望能夠從命令行來指定配置參數的話該如何做呢？<br>首先我們可以透過<code>-h</code>來看命令行參數可以設定哪些配置，以及每個參數的說明。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ python your_app.py -h</span><br><span class="line"></span><br><span class="line">usage: your_app [-h] [--config-dir DIR] [--config-file PATH]</span><br><span class="line">                [--periodic_task-noperiodic_enable]</span><br><span class="line">                [--periodic_task-periodic_enable]</span><br><span class="line">                [--periodic_task-periodic_interval PERIODIC_TASK_PERIODIC_INTERVAL]</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --<span class="built_in">help</span>            show this <span class="built_in">help</span> message and <span class="built_in">exit</span></span><br><span class="line">  --config-dir DIR      Path to a config directory to pull *.conf files from.</span><br><span class="line">                        This file <span class="built_in">set</span> is sorted, so as to provide a</span><br><span class="line">                        predictable parse order <span class="keyword">if</span> individual options are</span><br><span class="line">                        over-ridden. The <span class="built_in">set</span> is parsed after the file(s)</span><br><span class="line">                        specified via previous --config-file, arguments hence</span><br><span class="line">                        over-ridden options <span class="keyword">in</span> the directory take precedence.</span><br><span class="line">  --config-file PATH    Path to a config file to use. Multiple config files</span><br><span class="line">                        can be specified, with values <span class="keyword">in</span> later files taking</span><br><span class="line">                        precedence. Defaults to None.</span><br><span class="line"></span><br><span class="line">Periodic Tasks Options:</span><br><span class="line">  --periodic_task-noperiodic_enable</span><br><span class="line">                        The inverse of --periodic_enable</span><br><span class="line">  --periodic_task-periodic_enable</span><br><span class="line">                        Enable periodic tasks.</span><br><span class="line">  --periodic_task-periodic_interval PERIODIC_TASK_PERIODIC_INTERVAL</span><br><span class="line">                        Max interval size between periodic tasks execution <span class="keyword">in</span></span><br><span class="line">                        seconds.</span><br></pre></td></tr></table></figure>
<p>這時在透過以下指令，即可在命令行中指定配置參數。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python your_app.py --config-file your_app.conf --periodic_task-periodic_interval 1000</span><br></pre></td></tr></table></figure>
<p>以上，即是最簡單但也是最核心的<code>Oslo_config</code>使用方法。</p>
<h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><p>1.<a href="https://wiki.openstack.org/wiki/Oslo" target="_blank" rel="noopener">https://wiki.openstack.org/wiki/Oslo</a> Oslo WiKi<br>2.<a href="https://wiki.openstack.org/wiki/Oslo/Config" target="_blank" rel="noopener">https://wiki.openstack.org/wiki/Oslo/Config</a> Oslo.config WiKi<br>3.<a href="https://github.com/openstack/magnum" target="_blank" rel="noopener">https://github.com/openstack/magnum</a> OpenStack Magnum Source code<br>4.<a href="http://www.choudan.net/2013/11/27/OpenStack-Oslo.config-%E5%AD%A6%E4%B9%A0(%E4%B8%80).html" target="_blank" rel="noopener">http://www.choudan.net/2013/11/27/OpenStack-Oslo.config-%E5%AD%A6%E4%B9%A0(%E4%B8%80).html</a><br>5.<a href="http://gtcsq.readthedocs.io/en/latest/openstack/oslo_cfg.html" target="_blank" rel="noopener">http://gtcsq.readthedocs.io/en/latest/openstack/oslo_cfg.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/me.jpg" alt="Jack Lin">
            
              <p class="site-author-name" itemprop="name">Jack Lin</p>
              <p class="site-description motion-element" itemprop="description">Currently an exchange student in Germany. Kubeflow member and Kubeflow/tf-operator reviewer.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">文章</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分類</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">標籤</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/ChanYiLin" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.linkedin.com/in/jack-lin-a43506a2/" target="_blank" title="Linkedin">
                      
                        <i class="fa fa-fw fa-linkedin"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.facebook.com/yourname" target="_blank" title="FB Page">
                      
                        <i class="fa fa-fw fa-facebook"></i></a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jack Lin</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://jacklinblog-1.disqus.com/count.js" async></script>
    

    

  




	





  














  





  

  

  

  
  

  

  

  

</body>
</html>
