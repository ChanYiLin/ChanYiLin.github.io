<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-tw">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Cloud Computing, Distributed System, Kubernetes, Deep Learning, Jack Lin">










<meta name="description" content="目前任職於 InfuseAI. 專注於Kubeflow與Kubernetes. 同時也是 Kubeflow member與Kubeflow/tf-operator reviewer.">
<meta property="og:type" content="website">
<meta property="og:title" content="Distributed World">
<meta property="og:url" content="https://chanyilin.github.io/index.html">
<meta property="og:site_name" content="Distributed World">
<meta property="og:description" content="目前任職於 InfuseAI. 專注於Kubeflow與Kubernetes. 同時也是 Kubeflow member與Kubeflow/tf-operator reviewer.">
<meta property="og:locale" content="zh-tw">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Distributed World">
<meta name="twitter:description" content="目前任職於 InfuseAI. 專注於Kubeflow與Kubernetes. 同時也是 Kubeflow member與Kubeflow/tf-operator reviewer.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://chanyilin.github.io/">





  <title>Distributed World</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-58777369-2', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-tw">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Distributed World</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            關於
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            標籤
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            分類
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            歸檔
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://chanyilin.github.io/kubeflow-v0-7-0-deploy.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jack Lin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Distributed World">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kubeflow-v0-7-0-deploy.html" itemprop="url">Kubeflow v0.7 - Multi-user, auth-enabled 部署與安裝</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2019-11-27T10:28:12+08:00">
                2019-11-27
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/kubeflow-v0-7-0-deploy.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="kubeflow-v0-7-0-deploy.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          Kubeflow是一個開源軟體，致力於提供使用者於Kubernetes上快速便捷的部署與管理ML Workflow
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/kubeflow-v0-7-0-deploy.html">
              閱讀全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://chanyilin.github.io/kubeflow-istio-authnz-2.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jack Lin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Distributed World">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kubeflow-istio-authnz-2.html" itemprop="url">kubeflow-istio-authnz-2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2019-11-12T16:17:10+08:00">
                2019-11-12
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/kubeflow-istio-authnz-2.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="kubeflow-istio-authnz-2.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>昨天提到了透過<code>Kubernetes RBAC</code>與<code>Istio ServiceRole/ServiceRoleBinding</code>來做服務與資源的權限認證，以達成<strong>Multi-user</strong>情境。</p>
<p>今天來說說如何進行認證，以及這個獨立的<code>AuthService</code>是什麼。</p>
<h1 id="Istio-Gateway-and-EnvoyFilter-做認證"><a href="#Istio-Gateway-and-EnvoyFilter-做認證" class="headerlink" title="Istio-Gateway and EnvoyFilter 做認證"></a>Istio-Gateway and EnvoyFilter 做認證</h1><p>我們提到Istio在判斷該使用者能否連線使用該服務透過的是請求上的<code>Header: kubeflow-userid</code>，這便是在做使用者認證時另外覆寫夾帶上去的，使用的是Kubeflow額外開發的認證服務<code>AuthService</code>。</p>
<p><img src="https://i.imgur.com/bUZsAsI.png" alt=""></p>
<p>從這張圖可以看到所有的請求都會被這個<code>Istio Gateway</code>導向這個<code>OIDC AuthService</code>並接上第三方身份管理服務來認證使用者。</p>
<p>這個將請求導流的方法利用到的就是<code>Istio EnvoyFilter</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">EnvoyFilter/authn-filter</span> <span class="bullet">-n</span> <span class="string">kubeflow</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">EnvoyFilter</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  generation:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">authn-filter</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kubeflow</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  filters:</span></span><br><span class="line"><span class="attr">  - filterConfig:</span></span><br><span class="line"><span class="attr">      httpService:</span></span><br><span class="line"><span class="attr">        authorizationRequest:</span></span><br><span class="line"><span class="attr">          allowedHeaders:</span></span><br><span class="line"><span class="attr">            patterns:</span></span><br><span class="line"><span class="attr">            - exact:</span> <span class="string">cookie</span></span><br><span class="line"><span class="attr">        authorizationResponse:</span></span><br><span class="line"><span class="attr">          allowedUpstreamHeaders:</span></span><br><span class="line"><span class="attr">            patterns:</span></span><br><span class="line"><span class="attr">            - exact:</span> <span class="string">kubeflow-userid</span></span><br><span class="line"><span class="attr">        serverUri:</span></span><br><span class="line"><span class="attr">          cluster:</span> <span class="string">outbound|8080||authservice.istio-system.svc.cluster.local</span></span><br><span class="line"><span class="attr">          failureModeAllow:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">          timeout:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">http://authservice.istio-system.svc.cluster.local</span></span><br><span class="line"><span class="attr">      statusOnError:</span></span><br><span class="line"><span class="attr">        code:</span> <span class="string">GatewayTimeout</span></span><br><span class="line"><span class="attr">    filterName:</span> <span class="string">envoy.ext_authz</span></span><br><span class="line"><span class="attr">    filterType:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">    insertPosition:</span></span><br><span class="line"><span class="attr">      index:</span> <span class="string">FIRST</span></span><br><span class="line"><span class="attr">    listenerMatch:</span></span><br><span class="line"><span class="attr">      listenerType:</span> <span class="string">GATEWAY</span></span><br><span class="line"><span class="attr">      portNumber:</span> <span class="number">443</span></span><br><span class="line"><span class="attr">  workloadLabels:</span></span><br><span class="line"><span class="attr">    istio:</span> <span class="string">ingressgateway</span></span><br></pre></td></tr></table></figure>
<p>可以看到上面直接在<code>Istio ingressgateway</code>上面加上一個HTTP Filter將從<code>port:443</code>的流量全部倒向<code>http://authservice.istio-system.svc.cluster.local</code>，並允許<code>UpstreamHeaders</code>加上<code>Header: kubeflow-userid</code>。</p>
<blockquote>
<p><strong>authorizationResponse.allowed_upstream_headers:</strong> When this list is set, authorization response headers that have a correspondent match will be added to the original client request. Note that coexistent headers will be overridden.</p>
</blockquote>
<h2 id="AuthService-and-OIDC-Workflow"><a href="#AuthService-and-OIDC-Workflow" class="headerlink" title="AuthService and OIDC Workflow"></a>AuthService and OIDC Workflow</h2><p>如同上面所說，所有的請求都會先通過<code>Istio ingressgateway</code>，而被導向<code>AuthService</code>這一個獨立的服務來對Dex進行OIDC認證，而Dex可以再接第三方的身份管理服務。</p>
<p>而完整的請求流程如同下圖，</p>
<p><img src="https://i.imgur.com/F33m3TK.png" alt=""></p>
<p>圖中的Ambassador對應到Kubeflow目前的架構就是<code>Istio ingressgateway</code>。</p>
<ol>
<li>當使用者未登入時，AuthService會將該使用者導引到登入頁面，進行登入與OIDC流程。</li>
<li>使用者登入後，會呼叫定義好的callback uri，在這邊是<code>https://KUBEFLOWDOMAIN/login/oidc</code>。</li>
<li>請求再一次通過gateway並被導引到AuthService，這一次AuthService有了使用者的登入資訊。</li>
<li>AuthService將使用者登入資訊轉成jwt並且存入cookie，並將使用者導引回最初存取的Kubeflow服務。</li>
<li>請求這一次通過AuthService，會被AuthService加上從jwt解析出來的<code>user_id</code>並被加上<code>header kubeflow_user:user_id</code>。</li>
<li>接著由前一篇提到的<code>istio ServiceRole/ServiceRoleBinding</code>來從<code>header</code>中夾帶的使用者名稱判斷該請求是否可以存取目標服務。</li>
</ol>
<p>而程式碼可以直接參考以下連結，v0.7版所用的AuthService即是編譯自下面這個<code>arrikto/ambassador-auth-oidc:feature-kubeflow</code> project與branch。<br><a href="https://github.com/arrikto/ambassador-auth-oidc/tree/feature-kubeflow" target="_blank" rel="noopener">https://github.com/arrikto/ambassador-auth-oidc/tree/feature-kubeflow</a></p>
<h1 id="Kfam"><a href="#Kfam" class="headerlink" title="Kfam"></a>Kfam</h1><p>Project: <a href="https://github.com/kubeflow/kubeflow/tree/master/components/access-management" target="_blank" rel="noopener">https://github.com/kubeflow/kubeflow/tree/master/components/access-management</a></p>
<p>我們現在了解了Kubeflow如何實作認證與權限管理，每一個使用者會擁有自己的一個Namespace，可以與其他使用者做隔離。<br>但是關於共享資源的group又是怎麼實現與管理的呢？</p>
<p>這就要提到Kubeflow另一個元件 - <strong>Kfam</strong>。</p>
<h2 id="介紹"><a href="#介紹" class="headerlink" title="介紹"></a>介紹</h2><p>Kfam(Kubeflow Access Management API) 是一個HTTP Server，提供namespace層級的access control管理。</p>
<p>前面提到權限管理由兩種RBAC資源來實現，而Kfam就是提供了一層管理以下兩種資源的API。</p>
<ol>
<li><p>Profile</p>
<ul>
<li>標示一個使用者</li>
<li>擁有屬於自己的Namespace</li>
<li>創建相關的istio RBAC資源管理服務權限</li>
<li>創建相關的K8s RBAC資源管理K8s資源權限</li>
<li>透過Binding來管理使用者與權限關係</li>
</ul>
</li>
<li><p>Binding</p>
<ul>
<li>標示使用者與Namespace關係</li>
<li>允許使用者操作該Namespace資源</li>
</ul>
</li>
</ol>
<p>以下直接使用情境來說明group如何運作。</p>
<h2 id="不屬於該Group"><a href="#不屬於該Group" class="headerlink" title="不屬於該Group"></a>不屬於該Group</h2><p>如果一個使用者為<code>admin</code>，且希望能夠取得所有在<code>user</code>這個使用者的<code>namespace</code>底下的notebook，則會得到這樣的錯誤</p>
<p><img src="https://i.imgur.com/E5bct4f.png" alt=""></p>
<p>這非常合理，因為admin並沒有權限取得<code>user</code>的資源或是服務，且admin並不共享user namespace。</p>
<p>而這部分的判斷其實是來自這一個部分，透過K8s RBAC達成。因為現在所有的Kubeflow服務都可以從請求的<code>header</code>中取得<code>user_id</code>，所以可以知道目前希望操作notebook的使用者是誰，再參考K8s RBAC，即可知道該使用者是否有權限。<br><img src="https://i.imgur.com/VlRX1zB.png" alt=""></p>
<h3 id="直接看程式碼吧"><a href="#直接看程式碼吧" class="headerlink" title="直接看程式碼吧"></a>直接看程式碼吧</h3><p>也因此上面的邏輯其實是實作在Kubeflow的<code>jupyter-web-app</code>服務。</p>
<p>components/jupyter-web-app/backend/kubeflow_jupyter/common/api.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_notebooks</span><span class="params">(ns, user=None)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> is_authorized(user, ns):</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">"success"</span>: <span class="keyword">False</span>,</span><br><span class="line">            <span class="string">"log"</span>: <span class="string">"User '&#123;&#125;' is not authorized for namespace '&#123;&#125;'"</span>.format(</span><br><span class="line">                user, ns</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrap_resp(</span><br><span class="line">        <span class="string">"notebooks"</span>,</span><br><span class="line">        custom_api.list_namespaced_custom_object,</span><br><span class="line">        <span class="string">"kubeflow.org"</span>,</span><br><span class="line">        <span class="string">"v1beta1"</span>,</span><br><span class="line">        ns,</span><br><span class="line">        <span class="string">"notebooks"</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<p>components/jupyter-web-app/backend/kubeflow_jupyter/common/api.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_authorized</span><span class="params">(user, namespace)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    Queries KFAM for whether the provided user has access</span></span><br><span class="line"><span class="string">    to the specific namespace</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">        <span class="comment"># In case a user is not present, preserve the behavior from 0.5</span></span><br><span class="line">        <span class="comment"># Pass the authorization check and make the calls with the webapp's SA</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        resp = requests.get(<span class="string">"http://&#123;&#125;/kfam/v1/bindings?namespace=&#123;&#125;"</span>.format(</span><br><span class="line">            KFAM, namespace)</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.warning(<span class="string">"Error talking to KFAM: &#123;&#125;"</span>.format(parse_error(e)))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> resp.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="comment"># Iterate through the namespace's bindings and check for the user</span></span><br><span class="line">        <span class="keyword">for</span> binding <span class="keyword">in</span> resp.json().get(<span class="string">"bindings"</span>, []):</span><br><span class="line">            <span class="keyword">if</span> binding[<span class="string">"user"</span>][<span class="string">"name"</span>] == user:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.warning(<span class="string">"&#123;&#125;: Error talking to KFAM!"</span>.format(resp.status_code))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br></pre></td></tr></table></figure></p>
<p>透過從Kfam檢查<code>Binding</code>，Jupyter UI即可知道該使用者是否有權限存取操作特定Namespace底下的資源。</p>
<p>那我們如何將admin加入成為user的共同編輯者呢？</p>
<h2 id="將使用者加入某一個group"><a href="#將使用者加入某一個group" class="headerlink" title="將使用者加入某一個group"></a>將使用者加入某一個group</h2><p>有了上面這個概念後就會知道，其實Kubeflow沒有特別創建出不同於user的一個group的資源，一個user也可以是group，只要我們讓多個使用者有跟該user一樣在特定namespace底下的權限。</p>
<p>如下圖，其實ML Engineer也是一個user有自己的Namespace，只是其餘使用者也擁有操作<code>Namespace:ML Engineer</code>資源的權限。<br><img src="https://i.imgur.com/RKJaYRn.png" alt=""></p>
<h3 id="直接看程式碼吧-1"><a href="#直接看程式碼吧-1" class="headerlink" title="直接看程式碼吧"></a>直接看程式碼吧</h3><p>在安裝好的Kubeflow 0.7 CentralDashboard你可以看到有一個頁面可以加入其餘使用者成為Contributor，這背後的邏輯如下。</p>
<p>components/centraldashboard/app/api_workgroup.ts#L189<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const binding = mapSimpleBindingToWorkgroupBinding(&#123;</span><br><span class="line">                user: contributor,</span><br><span class="line">                namespace,</span><br><span class="line">                role: <span class="string">'contributor'</span>,</span><br><span class="line">            &#125;);</span><br><span class="line">const &#123;headers&#125; = req;</span><br><span class="line">delete headers[<span class="string">'content-length'</span>];</span><br><span class="line">const actionAPI = action === 'create' ? 'createBinding' : 'deleteBinding';</span><br><span class="line"><span class="keyword">await</span> profilesService[actionAPI](binding, &#123;headers&#125;); // actionAPI = Create</span><br><span class="line">errIndex++;</span><br><span class="line">const users = <span class="keyword">await</span> this.getContributors(namespace);</span><br><span class="line">res.json(users);</span><br></pre></td></tr></table></figure></p>
<p>當你將另一個使用者加為Contributor時，他就創建了一個<code>Binding</code>標示該使用者與你的Namespace有聯繫。</p>
<p>而這個Binding會近一步創建K8s與Istio的RBAC資源，來賦予該使用者在這個Namespace的權限。</p>
<p>舉例來說，一個使用者<code>Jack</code>，被加入成為另一個使用者<code>MLEngineer</code>的Contributor。則會自動創建RBAC資源賦予<code>Jack</code>在該Namespace底下的<code>ClusterRole:admin</code>與<code>ServiceRole:ns-access-istio</code>的權限。</p>
<p>而這幾個RBAC資源的創建就是在<strong>Kfam</strong> API裡面。</p>
<p>kfam/routers.go<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Route&#123;</span><br><span class="line">    <span class="string">"CreateBinding"</span>,</span><br><span class="line">    strings.ToUpper(<span class="string">"Post"</span>),</span><br><span class="line">    <span class="string">"/kfam/v1/bindings"</span>,</span><br><span class="line">    kfamV1Alpha1.CreateBinding,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>kfam/api_default.go<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *KfamV1Alpha1Client)</span> <span class="title">CreateBinding</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"application/json; charset=UTF-8"</span>)</span><br><span class="line">    <span class="keyword">var</span> binding Binding</span><br><span class="line">    <span class="keyword">if</span> err := json.NewDecoder(r.Body).Decode(&amp;binding); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        json.NewEncoder(w).Encode(err)</span><br><span class="line">        w.WriteHeader(http.StatusForbidden)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// check permission before create binding</span></span><br><span class="line">    useremail := c.getUserEmail(r.Header)</span><br><span class="line">    <span class="keyword">if</span> c.isOwnerOrAdmin(useremail, binding.ReferredNamespace) &#123;</span><br><span class="line">        err := c.bindingClient.Create(&amp;binding, c.userIdHeader, c.userIdPrefix)</span><br><span class="line">        <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">            w.WriteHeader(http.StatusOK)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            w.WriteHeader(http.StatusForbidden)</span><br><span class="line">            w.Write([]<span class="keyword">byte</span>(err.Error()))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        w.WriteHeader(http.StatusForbidden)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>kfam/bindings.go<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *BindingClient)</span> <span class="title">Create</span><span class="params">(binding *Binding, userIdHeader <span class="keyword">string</span>, userIdPrefix <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> permission check before go ahead</span></span><br><span class="line">    bindingName, err := getBindingName(binding)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    roleBinding := rbacv1.RoleBinding&#123;</span><br><span class="line">        ObjectMeta: metav1.ObjectMeta&#123;</span><br><span class="line">            Annotations: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;USER: binding.User.Name, ROLE: binding.RoleRef.Name&#125;,</span><br><span class="line">            Name: bindingName,</span><br><span class="line">        &#125;,</span><br><span class="line">        RoleRef: rbacv1.RoleRef&#123;</span><br><span class="line">            APIGroup: binding.RoleRef.APIGroup,</span><br><span class="line">            Kind: binding.RoleRef.Kind,</span><br><span class="line">            Name: roleBindingNameMap[binding.RoleRef.Name],</span><br><span class="line">        &#125;,</span><br><span class="line">        Subjects: []rbacv1.Subject&#123;</span><br><span class="line">            *binding.User,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    _, err = c.kubeClient.RbacV1().RoleBindings(binding.ReferredNamespace).Create(&amp;roleBinding)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create istio service role binding</span></span><br><span class="line">    istioServiceRoleBinding := &amp;istiorbac.ServiceRoleBinding&#123;</span><br><span class="line">        ObjectMeta: metav1.ObjectMeta&#123;</span><br><span class="line">            Annotations: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;USER: binding.User.Name, ROLE: binding.RoleRef.Name&#125;,</span><br><span class="line">            Name:      bindingName,</span><br><span class="line">            Namespace: binding.ReferredNamespace,</span><br><span class="line">        &#125;,</span><br><span class="line">        Spec: istiorbac.ServiceRoleBindingSpec&#123;</span><br><span class="line">            Subjects: []*istiorbac.Subject&#123;</span><br><span class="line">                &#123;</span><br><span class="line">                    Properties: <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;fmt.Sprintf(<span class="string">"request.headers[%v]"</span>, userIdHeader): userIdPrefix + binding.User.Name&#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">            RoleRef: &amp;istiorbac.RoleRef&#123;</span><br><span class="line">                Kind: <span class="string">"ServiceRole"</span>,</span><br><span class="line">                Name: SERVICEROLEISTIO,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    result := istiorbac.ServiceRoleBinding&#123;&#125;</span><br><span class="line">    <span class="keyword">return</span> c.restClient.</span><br><span class="line">        Post().</span><br><span class="line">        Namespace(binding.ReferredNamespace).</span><br><span class="line">        Resource(ServiceRoleBinding).</span><br><span class="line">        Body(istioServiceRoleBinding).</span><br><span class="line">        Do().</span><br><span class="line">        Into(&amp;result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h1><p>透過今天這一篇，我們就完整暸解Kubeflow如何利用Istio來進行認證。並透過完整的身份管理來建構出Multi-user與Group的使用情境。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://chanyilin.github.io/kubeflow-istio-authnz.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jack Lin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Distributed World">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/kubeflow-istio-authnz.html" itemprop="url">Kubeflow如何搭配Istio實作Multi-user認證與權限管理(上)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2019-11-12T16:06:18+08:00">
                2019-11-12
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/kubeflow-istio-authnz.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="kubeflow-istio-authnz.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://i.imgur.com/6kTYwIR.png" alt=""></p>
<h1 id="發展"><a href="#發展" class="headerlink" title="發展"></a>發展</h1><p>Kubeflow是一個開源軟體，目的在提供使用者於Kubernetes上部署與管理Machine Learning Workflow。從最開始可以整合<code>Jupyterhub</code>做單機訓練、或是利用<code>tf-operator</code>管理分散式訓練，到最近加入<code>Pipeline</code>功能來整合前面資料處理與後續的模型服務，功能性與規模可以說在這一兩年快速成長。現在，在最新的版本中更是搭配<code>Dashboard UI</code>加入<strong>使用者認證</strong>與<strong>權限管理</strong>的功能，讓一個Kubeflow可以讓多人使用，並透過<strong>Group</strong>的概念在多個使用者間共享資源與權限，旨在成為一個通用全方位的AI平台。</p>
<p>原本的Kubeflow各項服務都是獨立的專案，使用方式是分別的操作<code>Jupyter UI</code>來開啟Jupyterhub，或是使用<code>Kubeflow Pipeline UI</code>來創建一個Workflow。這使得整體的使用有些破碎，Kubeflow在接下來的發展將會搭配一個統一的<code>Dashboard UI</code>與認證方案來解決，以下是過去的缺點與將帶來的好處。</p>
<ul>
<li>過去使用者必須對K8s有一定程度的瞭解，甚至在使用Kubeflow服務時，必須用<code>kubectl</code>來操作K8s資源，這提高了Data Scientists使用的門檻。<ul>
<li>接下來的Kubeflow發展將讓使用者更好理解各項服務的資源，將low-level K8s API Resource抽象並近一步定義<strong>high level Kubeflow API</strong>。</li>
</ul>
</li>
<li>過去每一個服務相互獨立，並不方便完成使用者認證與權限管理，使用每一個服務時都必須單獨做認證。<ul>
<li>搭配一個統一的<code>Dashboard UI</code>與<code>Kubeflow API Entry Point</code>，使用者使用服務時只要在<code>Entry Point</code>這一層做認證。</li>
</ul>
</li>
</ul>
<p>而當我們定義了一系列<strong>Kubeflow API Resource</strong>，像是<code>models</code>、<code>trainging dataset</code>、<code>pipelines</code>等。我們就可以在這些資源上自然地執行權限管理。</p>
<h1 id="Kubeflow-Multi-user情境"><a href="#Kubeflow-Multi-user情境" class="headerlink" title="Kubeflow Multi-user情境"></a>Kubeflow Multi-user情境</h1><p>過去除了缺乏一個統一的Kubeflow API Entry Point與Kubeflow API Resource外，<strong>Multi-user</strong>的情境也是大家夢寐以求的。</p>
<p>一個合理的Multi-user情境如下<br><img src="https://i.imgur.com/RKJaYRn.png" alt=""></p>
<p>多個使用者會擁有自己的Kubeflow資源，且與其餘使用者隔離，比方說創建的<code>pipeline</code>或是<code>notebook</code>。<br>同時Kubeflow也提供共享的Group資源，可以讓多個使用者共同分享。</p>
<p>而<strong>Multi-user</strong>、<strong>認證權限管理</strong>與<strong>Kubeflow API Resource</strong>彼此相輔相成，以下開始介紹Kubeflow怎麼提出一個完整的解決方法。</p>
<h1 id="Kubeflow-Kubernetes認證與權限管理"><a href="#Kubeflow-Kubernetes認證與權限管理" class="headerlink" title="Kubeflow/Kubernetes認證與權限管理"></a>Kubeflow/Kubernetes認證與權限管理</h1><p>附圖是認證與權限管理的架構流程圖</p>
<p><img src="https://i.imgur.com/pJB7e0T.png" alt=""></p>
<p>透過一個<code>Kubeflow API Gateway</code>，所有使用Kubeflow服務請求可以在這一層做認證與權限管理。</p>
<p>第一點注意到的是，其實我們需要針對兩種資源與服務做認證與權限，也就是Kubernets原生資源與Kubeflow資源。</p>
<p>舉幾個例子可以讓大家快速了解這兩個資源使用情境。</p>
<ol>
<li><p>對於Kubeflow認證與權限的情境比方說</p>
<ul>
<li>當透過<code>Kubeflow/Jupyterhub UI</code>開一個notebook，首先會透過瀏覽器連到Kubeflow Jupyterhub UI服務，這邊是<strong>Kubeflow層級服務</strong>需要做<strong>使用者認證</strong>來驗證使用者可否用這個服務。</li>
<li>開啟notebook後，哪些帳號可以共同編輯該notebook，甚至在這裏引進group概念，同一個group的成員都可以編輯共享的notebook。</li>
</ul>
</li>
<li><p>對於Kubernetes認證與權限的情境比方說</p>
<ul>
<li>在自己的帳號底下可以列出哪些notebook pod</li>
<li>使用kubctl直接操作Kubernetes資源</li>
</ul>
</li>
</ol>
<p>也因此我們在管理使用者與群組的認證與權限時，必須將Kubeflow服務層級與Kubernetes原生資源整合。</p>
<p>而Kubeflow給出的答案就是使用</p>
<ol>
<li>一個獨立的authservice</li>
<li>Istio/Istio-RBAC</li>
<li>Kubernetes Namespace/RBAC</li>
</ol>
<h1 id="Kubeflow-Profiles-Operator"><a href="#Kubeflow-Profiles-Operator" class="headerlink" title="Kubeflow Profiles Operator"></a>Kubeflow Profiles Operator</h1><p>我們先來看<strong>資源使用權限</strong>如何實作。</p>
<p>Kubeflow使用的是一個 <a href="https://github.com/kubeflow/kubeflow/tree/master/components/profile-controller" target="_blank" rel="noopener">Profile Operator</a> 來管理使用者的資源使用權限。</p>
<p>當在Kubeflow創建一個使用者時，其實是創建了一個<strong>Profile CRD</strong>。同時每一個使用者都會被賦予一個<strong>Namespace</strong>與在該Namespace操作創建資源的<strong>Privilege</strong>。這部分便是透過 <code>Profile-Operator</code>、<code>istio RBAC</code>與<code>K8s RBAC</code>。</p>
<p>我們直接從哪些資源會跟著Profile創建來看。</p>
<h2 id="Profile-CRD"><a href="#Profile-CRD" class="headerlink" title="Profile CRD"></a>Profile CRD</h2><p>一個Profile會包含名稱與信箱<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeflow.org/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Profile</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  owner:</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">User</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">admin@kubeflow.org</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h2><p>Controller會創建一個與使用者同名的Namespace，並標為<code>istio-enabled</code>以利後面引入<code>Istio</code>做認證與權限管理。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line"><span class="attr">    owner:</span> <span class="string">admin@kubeflow.org</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    istio-injection:</span> <span class="string">enabled</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  finalizers:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line"><span class="attr">  phase:</span> <span class="string">Active</span></span><br></pre></td></tr></table></figure>
<h2 id="Istio-RBAC"><a href="#Istio-RBAC" class="headerlink" title="Istio RBAC"></a>Istio RBAC</h2><p>這部分就是利用Istio來實作權限認證的環節，限制使用者可以連線使用的服務。方法是在該使用者的Namespace底下創建<code>Istio-ServiceRole</code>與<code>Istio-ServiceRoleBinding</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="bullet">-o</span> <span class="string">yaml</span> <span class="string">servicerole/ns-access-istio</span> <span class="bullet">-n</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.istio.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line"><span class="attr">    role:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">admin@kubeflow.org</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">ns-access-istio</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">  - services:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">'*'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="bullet">-o</span> <span class="string">yaml</span> <span class="string">servicerolebinding/owner-binding-istio</span> <span class="bullet">-n</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.istio.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line"><span class="attr">    role:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">admin@kubeflow.org</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">owner-binding-istio</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  roleRef:</span></span><br><span class="line"><span class="attr">    kind:</span> <span class="string">ServiceRole</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">ns-access-istio</span></span><br><span class="line"><span class="attr">  subjects:</span></span><br><span class="line"><span class="attr">  - properties:</span></span><br><span class="line">      <span class="string">request.headers[kubeflow-userid]:</span> <span class="string">admin@kubeflow.org</span></span><br></pre></td></tr></table></figure>
<p>透過<code>Istio-ServiceRole</code>與<code>Istio-ServiceRoleBinding</code>使得只有該使用者有權限可以連線該Namespace底下的服務。可以看到的是這邊如何認知送來的請求是該使用者，檢查的是<code>Header</code>裡面的<code>kubeflow-userid</code>欄位。這個欄位就是在使用者登入後覆寫夾帶的欄位，後面會介紹這部分的環節。</p>
<h2 id="Owner-rbac-permission"><a href="#Owner-rbac-permission" class="headerlink" title="Owner rbac permission"></a>Owner rbac permission</h2><p>剛剛是利用Istio來實作服務的權限管理，接下來是<strong>Kubernetes原生資源</strong>的權限管理，這邊就是用大家比較熟悉的RBAC，也就是<code>ClusterRole</code>與<code>RoleBinding</code>。另外特別需要注意的就是ClusterRole雖然是Cluster scoped的權限，但是當他透過Namespace scoped的<code>RoleBinding</code>綁定到使用者後，就是Namespace scoped的權限。</p>
<p>以下<code>RoleBinding</code>將<strong>admin權限</strong>綁定到<strong>admin</strong>這個user。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line"><span class="attr">    role:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">admin@kubeflow.org</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">namespaceAdmin</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">admin</span> <span class="comment">#Namespace permission</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">admin</span> <span class="comment"># original Kubernetes ClusterRole</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">User</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">admin@kubeflow.org</span></span><br></pre></td></tr></table></figure></p>
<h2 id="ServiceAccount"><a href="#ServiceAccount" class="headerlink" title="ServiceAccount"></a>ServiceAccount</h2><ol>
<li><strong>default-deitor:</strong> 帶有edit權限的<code>ServiceAccount</code>，可以改動<code>Namespace admin</code>底下的所有資源，除了RBAC。用途比方說，Jupyterhub在該Namespace底下的notebook pod就會是綁定這個<code>ServiceAccount</code></li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="bullet">-o</span> <span class="string">yaml</span> <span class="string">serviceaccount/default-editor</span> <span class="bullet">-n</span> <span class="string">admin</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">default-editor</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">admin</span> <span class="comment"># under admin namespace</span></span><br><span class="line"><span class="attr">secrets:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">default-editor-token-qrllp</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="bullet">-o</span> <span class="string">yaml</span> <span class="string">rolebinding/default-editor</span> <span class="bullet">-n</span> <span class="string">admin</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">default-editor</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span> <span class="comment"># Original K8s ClusterRole edit</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">edit</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">default-editor</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">admin</span> <span class="comment"># The Clusterrole is binding with namespace-scoped ServiceAccoun.</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li><strong>default-viewer:</strong> 帶有view權限的<code>ServiceAccount</code>，可以list/get <code>Namespace admin</code>底下的所有資源。</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="bullet">-o</span> <span class="string">yaml</span> <span class="string">serviceaccount/default-viewer</span> <span class="bullet">-n</span> <span class="string">admin</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">default-viewer</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">secrets:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">default-viewer-token-sdr96</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">default-viewer</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">view</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">default-viewer</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">admin</span></span><br></pre></td></tr></table></figure>
<h2 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h2><p>Kubeflow 使用 <code>Profile</code> 來管理使用者，圍繞這個CRD，管理<code>K8s RBAC</code>與<code>Istio RBAC</code>等相關資源來管理<strong>資源使用權限</strong>。</p>
<p>而透過這樣的資源全限管理，我們便可以發展多使用者與群組的功能，回顧一下一開始的情境圖。</p>
<p><img src="https://i.imgur.com/RKJaYRn.png" alt=""></p>
<p>也因此剩下的工作就是如何處理最外面的 <code>Istio Gateway</code>，並進而針對使用者做認證。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://chanyilin.github.io/argo.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jack Lin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Distributed World">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/argo.html" itemprop="url">Argo</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2019-02-07T01:24:27+08:00">
                2019-02-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubeflow/" itemprop="url" rel="index">
                    <span itemprop="name">Kubeflow</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubeflow/Kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">Kubernetes</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubeflow/Kubernetes/Workflow/" itemprop="url" rel="index">
                    <span itemprop="name">Workflow</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/argo.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="argo.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/images/argo.png" alt="argo"></p>
<p>Kubeflow 作為一個 Deep Learning service on Kubernetes 的專案，自然面對最大的問題就是如何將一個 DL 中的每一個 phase 串在一起。而眾多 workflow 工具中， Kubeflow 在這邊選擇使用的便是 - <code>Argo</code>。 Kubeflow 不只將 Argo 應用在 pipeline，也應用在它內部的CI/CD上，因此值得我們好好關注。</p>
<p>Argo 是一個基於 CRD 實作的一個 Workflow 工具，協助使用者管理與控制一系列任務的執行，<br>同時提供一個簡潔的UI介面觀看每一個任務的執行狀況、順序、結果與 log。<br>由於 Workflow 本身是一個 CRD，因此建立 workflow 的方法也是透過撰寫一個 yaml 檔，而 Argo 也針對如何描述一個 workflow 提供了許多的規則。</p>
<h2 id="部署Argo"><a href="#部署Argo" class="headerlink" title="部署Argo"></a>部署Argo</h2><p>我們這邊是獨立部署，如果是直接安裝Kubeflow，以下這些components已經安裝完畢，只需另外安裝argo client即可。</p>
<ol>
<li><p>首先下載安裝Argo client<br> Mac:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install argoproj/tap/argo</span><br></pre></td></tr></table></figure>
<p> Linux:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL -o /usr/local/bin/argo https://github.com/argoproj/argo/releases/download/v2.2.1/argo-linux-amd64</span><br><span class="line">chmod +x /usr/local/bin/argo</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下來安裝Argo Controller 與 UI</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns argo</span><br><span class="line">kubectl apply -n argo -f https://raw.githubusercontent.com/argoproj/argo/v2.2.1/manifests/install.yaml</span><br></pre></td></tr></table></figure>
<p> **NOTE: 因為上面的insall.yaml會需要在你的k8s中創建clusterrole。因此如果使用的是GKE，這邊需要特別開通權限。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding YOURNAME-cluster-admin-binding --clusterrole=cluster-admin --user=YOUREMAIL@gmail.com</span><br></pre></td></tr></table></figure>
<p> 安裝好後就會在k8s下面的argo namespace看到以下的components</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">NAME                         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deploy/argo-ui               1         1         1            1           84d</span><br><span class="line">deploy/workflow-controller   1         1         1            1           84d</span><br><span class="line"></span><br><span class="line">NAME                               DESIRED   CURRENT   READY     AGE</span><br><span class="line">rs/argo-ui-65bb8cf7f6              1         1         1         35s</span><br><span class="line">rs/argo-ui-6bb9c4485f              0         0         0         84d</span><br><span class="line">rs/workflow-controller-7f4dd6bd9   0         0         0         84d</span><br><span class="line">rs/workflow-controller-8fb5fb5d5   1         1         1         33s</span><br><span class="line"></span><br><span class="line">NAME                                     READY     STATUS        RESTARTS   AGE</span><br><span class="line">po/argo-ui-65bb8cf7f6-q2r59              1/1       Running       0          35s</span><br><span class="line">po/argo-ui-6bb9c4485f-7v2d5              1/1       Terminating   0          42d</span><br><span class="line">po/workflow-controller-8fb5fb5d5-spq99   1/1       Running       0          33s</span><br><span class="line"></span><br><span class="line">NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">svc/argo-ui   ClusterIP   10.27.255.240   &lt;none&gt;        80/TCP    84d</span><br></pre></td></tr></table></figure>
</li>
<li><p>在接下來使用Argo的過程中，default account的權限會限制一些功能，因此我們這邊在default account綁上admin privileges。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create rolebinding default-admin --clusterrole=admin --serviceaccount=default:default</span><br></pre></td></tr></table></figure>
<p> 也可以在執行的workflow時指定使用的是哪一個service account</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">argo submit --serviceaccount &lt;name&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>以上即完成Argo的部署。</p>
<h2 id="使用Argo-UI"><a href="#使用Argo-UI" class="headerlink" title="使用Argo UI"></a>使用Argo UI</h2><p>Argo UI 可以讓使用者輕鬆關觀察一個 workflow 的狀況，並檢查每一個步驟的結果與錯誤訊息。</p>
<p><strong>kubectl port-forward</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n argo port-forward deployment/argo-ui 8001:8001</span><br></pre></td></tr></table></figure></p>
<p>透過 <a href="http://127.0.0.1:8001" target="_blank" rel="noopener">http://127.0.0.1:8001</a> 使用</p>
<p><strong>Method 2: kubectl proxy</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy</span><br></pre></td></tr></table></figure></p>
<p>透過  <a href="http://127.0.0.1:8001/api/v1/namespaces/argo/services/argo-ui/proxy/" target="_blank" rel="noopener">http://127.0.0.1:8001/api/v1/namespaces/argo/services/argo-ui/proxy/</a> 使用</p>
<p><strong>Expose a LoadBalancer</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch svc argo-ui -n argo -p &apos;&#123;&quot;spec&quot;: &#123;&quot;type&quot;: &quot;LoadBalancer&quot;&#125;&#125;&apos;</span><br><span class="line"></span><br><span class="line">kubectl get svc argo-ui -n argo</span><br><span class="line">NAME      TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)        AGE</span><br><span class="line">argo-ui   LoadBalancer   10.19.255.205   35.197.49.167   80:30999/TCP   1m</span><br></pre></td></tr></table></figure></p>
<p>結果如下圖：</p>
<p><img src="/images/argo-ui.png" alt="argo-ui"></p>
<h2 id="Argo-範例與解析"><a href="#Argo-範例與解析" class="headerlink" title="Argo 範例與解析"></a>Argo 範例與解析</h2><p>如同上面所說，Argo 也是透過自己實作一個 operator(CRD + controller) 來完成 Workflow 的功能。而所謂的在 k8s 中執行 workflow 的意思便是利用一個個 pod 來執行我們的每一個步驟。</p>
<p>因此我們這邊先來看幾個簡單的 argo crd，看看我們能設定哪些參數及能做到哪些事情。</p>
<p>首先提供一些常用的指令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">argo list #查看有哪些 workflow</span><br><span class="line">argo get xxx-workflow-name-xxx #查看這個 workflow 的狀態</span><br><span class="line">argo logs xxx-pod-name-xxx #查看這個 pod 的 output</span><br></pre></td></tr></table></figure></p>
<h3 id="coinflip"><a href="#coinflip" class="headerlink" title="coinflip"></a>coinflip</h3><p>這個範例的目標是，先丟一個硬幣，如果是 head 就執行 head 的工作，如果是 tail 就執行 tail 的工作。也就是 workflow 最基礎的 if-else 功能。</p>
<p>首先先利用以下指令來執行coinflip worklow：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">argo submit --watch https://raw.githubusercontent.com/argoproj/argo/master/examples/coinflip.yaml</span><br></pre></td></tr></table></figure></p>
<p>接著我們來分析中間發生了哪些事：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Name:                coinflip-czw7h</span><br><span class="line">Namespace:           default</span><br><span class="line">ServiceAccount:      default</span><br><span class="line">Status:              Succeeded</span><br><span class="line">Created:             Wed Feb 06 23:07:02 +0100 (38 seconds ago)</span><br><span class="line">Started:             Wed Feb 06 23:07:02 +0100 (38 seconds ago)</span><br><span class="line">Finished:            Wed Feb 06 23:07:40 +0100 (now)</span><br><span class="line">Duration:            38 seconds</span><br><span class="line"></span><br><span class="line">STEP               PODNAME                    DURATION  MESSAGE</span><br><span class="line"> ✔ coinflip-czw7h</span><br><span class="line"> ├---✔ flip-coin   coinflip-czw7h-3048772414  23s</span><br><span class="line"> └-·-○ heads                                            when &apos;tails == heads&apos; evaluated false</span><br><span class="line">   └-✔ tails       coinflip-czw7h-3790732747  13s</span><br></pre></td></tr></table></figure>
<p>這是你會看到的介面。上面呈現了一些基本的訊息，以及這個 workflow 每一個 steps 發生的事情與執行了哪個相對應得 pod。</p>
<p>因此問題便是，我們如何讓每一個 pod 知道上一步驟的結果，與如何傳遞結果給下一個步驟。</p>
<p>我們現在來細看這個coinflips到底怎麼做的，以下是他的yaml file：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: Workflow</span><br><span class="line">metadata:</span><br><span class="line">  generateName: coinflip-</span><br><span class="line">spec:</span><br><span class="line">  entrypoint: coinflip</span><br><span class="line">  templates:</span><br><span class="line">  - name: coinflip</span><br><span class="line">    steps:</span><br><span class="line">    - - name: flip-coin</span><br><span class="line">        template: flip-coin</span><br><span class="line">    - - name: heads</span><br><span class="line">        template: heads</span><br><span class="line">        when: &quot;&#123;&#123;steps.flip-coin.outputs.result&#125;&#125; == heads&quot;</span><br><span class="line">      - name: tails</span><br><span class="line">        template: tails</span><br><span class="line">        when: &quot;&#123;&#123;steps.flip-coin.outputs.result&#125;&#125; == tails&quot;</span><br><span class="line"></span><br><span class="line">  - name: flip-coin</span><br><span class="line">    script:</span><br><span class="line">      image: python:alpine3.6</span><br><span class="line">      command: [python]</span><br><span class="line">      source: |</span><br><span class="line">        import random</span><br><span class="line">        result = &quot;heads&quot; if random.randint(0,1) == 0 else &quot;tails&quot;</span><br><span class="line">        print(result)</span><br><span class="line"></span><br><span class="line">  - name: heads</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.6</span><br><span class="line">      command: [sh, -c]</span><br><span class="line">      args: [&quot;echo \&quot;it was heads\&quot;&quot;]</span><br><span class="line"></span><br><span class="line">  - name: tails</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.6</span><br><span class="line">      command: [sh, -c]</span><br><span class="line">      args: [&quot;echo \&quot;it was tails\&quot;&quot;]</span><br></pre></td></tr></table></figure>
<p>從上面可以很簡單知道：</p>
<ul>
<li><code>apiVersion: argoproj.io/v1alpha1</code> 與 <code>kind: Workflow</code> 說明了這是一個CRD</li>
<li><code>spec</code> 從 <code>entrypoing</code> 開始執行，在這邊即是從 <code>coinflip</code> 這個 <code>template</code> 開始</li>
<li><code>templates</code> 裡面的每一項描述的都是一個工作，包含<ul>
<li>名字</li>
<li>可以執行一個 <code>container</code> 或是執行 <code>script</code></li>
<li>container <code>image</code></li>
<li><code>command</code> 與 <code>args</code></li>
<li><code>steps</code> : 作用是排定一系列 <code>templates</code> 執行的先後順序</li>
</ul>
</li>
<li>coinflip 同時作為一個 <code>entrypoint</code> ，特別可以看到他裡面描述的是 <code>steps</code> ，且包含：<ul>
<li>每一步驟的名字</li>
<li>要執行的 <code>template</code></li>
<li>什麼時候執行</li>
</ul>
</li>
</ul>
<p>將上面的 yaml 轉成 json 可以視為[[flip-coin], [heads, tails]]，因此會先執行 flip-coin。而 flip-coin 透過執行的 <code>script</code> 會有一個 result 作為 output，表示擲出硬幣的結果。<br>而下面的步驟透過 <code>NaN</code> 來獲得特定步驟的 output 作為判斷的依據，進而可以達成 if-else 的workflow效果 。</p>
<p>Ref: 可另外參考 <a href="https://raw.githubusercontent.com/argoproj/argo/master/examples/coinflip-recursive.yaml" target="_blank" rel="noopener">coinflip-recursive</a></p>
<h3 id="dag-diamond"><a href="#dag-diamond" class="headerlink" title="dag-diamond"></a>dag-diamond</h3><p>在一個 workflow 中除了 <code>if-else</code> 外，有時也需要能夠表達工作之間的相依性，或是有時一些工作需要可以平行執行。而 Argo 便提供 <code>dag</code> 來描述工作的相依性，直接看範例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: Workflow</span><br><span class="line">metadata:</span><br><span class="line">  generateName: dag-diamond-</span><br><span class="line">spec:</span><br><span class="line">  entrypoint: diamond</span><br><span class="line">  templates:</span><br><span class="line">  - name: diamond</span><br><span class="line">    dag:</span><br><span class="line">      tasks:</span><br><span class="line">      - name: A</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: A&#125;]</span><br><span class="line">      - name: B</span><br><span class="line">        dependencies: [A]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: B&#125;]</span><br><span class="line">      - name: C</span><br><span class="line">        dependencies: [A]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: C&#125;]</span><br><span class="line">      - name: D</span><br><span class="line">        dependencies: [B, C]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: D&#125;]</span><br><span class="line"></span><br><span class="line">  - name: echo</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">      - name: message</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.7</span><br><span class="line">      command: [echo, &quot;&#123;&#123;inputs.parameters.message&#125;&#125;&quot;]</span><br></pre></td></tr></table></figure>
<p>可以注意到這邊沒有使用<code>steps</code>，而是使用<code>dag</code>。在<code>dag</code>中的每一項步驟皆可以使用<code>dependencies</code>來描述相依的工作，比方說 B,C 步驟便強迫要在 A 完成後才能執行。而當 A 完成後，B,C 滿足條件便會同時（平行）執行，最後才交由 D 執行。</p>
<p>透過 <code>dag</code> 便可以編排出工作的順序與相依性，或是讓工作平行執行。</p>
<h4 id="dag-與-steps"><a href="#dag-與-steps" class="headerlink" title="dag 與 steps"></a>dag 與 steps</h4><p>還記得剛剛的 flip-coin 範例嗎，透過steps也可以達成某程度的平行執行或是順序執行，但是無法表達相依性。什麼意思呢？</p>
<p>熟悉 yaml 的人應該會知道 yaml 跟 json 是等價可以互相轉換的，而 yaml 中的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">steps:</span><br><span class="line">    - - name: flip-coin</span><br><span class="line">        template: flip-coin</span><br><span class="line">    - - name: heads</span><br><span class="line">        template: heads</span><br><span class="line">        when: &quot;&#123;&#123;steps.flip-coin.outputs.result&#125;&#125; == heads&quot;</span><br><span class="line">      - name: tails</span><br><span class="line">        template: tails</span><br><span class="line">        when: &quot;&#123;&#123;steps.flip-coin.outputs.result&#125;&#125; == tails&quot;</span><br></pre></td></tr></table></figure>
<p>中間的 <code>- -</code> 表達的是 <em>list中的list</em> 的意思，也就是 [[flip-coin], [heads, tails]]。當 steps 再寫的時候如果是依序執行一律用<code>- -</code>，若是在同一個 list 內則會平行執行。</p>
<p>因此以下用一個例子比較：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  entrypoint: diamond</span><br><span class="line">  templates:</span><br><span class="line">  - name: diamond</span><br><span class="line">    steps:</span><br><span class="line">    - - name: A</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: A&#125;]</span><br><span class="line">    - - name: B</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: B&#125;]</span><br><span class="line">      - name: C</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: C&#125;]</span><br><span class="line">    - - name: D</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: D&#125;]</span><br><span class="line"></span><br><span class="line">  - name: echo</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">      - name: message</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.7</span><br><span class="line">      command: [echo, &quot;&#123;&#123;inputs.parameters.message&#125;&#125;&quot;]</span><br></pre></td></tr></table></figure></p>
<p>是等價於<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  entrypoint: diamond</span><br><span class="line">  templates:</span><br><span class="line">  - name: diamond</span><br><span class="line">    dag:</span><br><span class="line">      tasks:</span><br><span class="line">      - name: A</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: A&#125;]</span><br><span class="line">      - name: B</span><br><span class="line">        dependencies: [A]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: B&#125;]</span><br><span class="line">      - name: C</span><br><span class="line">        dependencies: [A]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: C&#125;]</span><br><span class="line">      - name: D</span><br><span class="line">        dependencies: [B, C]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: D&#125;]</span><br><span class="line"></span><br><span class="line">  - name: echo</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">      - name: message</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.7</span><br><span class="line">      command: [echo, &quot;&#123;&#123;inputs.parameters.message&#125;&#125;&quot;]</span><br></pre></td></tr></table></figure></p>
<p>如下圖透過UI看到的結果：</p>
<p><img src="/images/dag-steps-cmp.png" alt="dag-steps-cmp"></p>
<h3 id="conditionals"><a href="#conditionals" class="headerlink" title="conditionals"></a>conditionals</h3><p>了解了上面如何實現 <code>if-else</code> ,<code>依序執行</code>, <code>同時執行</code>後，最後在看一個範例解釋了如何在 workflow 執行時動態的給予參數，並影響結果，我們直接看yaml file：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: Workflow</span><br><span class="line">metadata:</span><br><span class="line">  generateName: conditional-</span><br><span class="line">spec:</span><br><span class="line">  entrypoint: conditional-example</span><br><span class="line">  arguments:</span><br><span class="line">    parameters:</span><br><span class="line">    - name: should-print</span><br><span class="line">      value: &quot;false&quot;</span><br><span class="line"></span><br><span class="line">  templates:</span><br><span class="line">  - name: conditional-example</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">      - name: should-print</span><br><span class="line">    steps:</span><br><span class="line">    - - name: print-hello</span><br><span class="line">        template: whalesay</span><br><span class="line">        when: &quot;&#123;&#123;inputs.parameters.should-print&#125;&#125; == true&quot;</span><br><span class="line"></span><br><span class="line">  - name: whalesay</span><br><span class="line">    container:</span><br><span class="line">      image: docker/whalesay:latest</span><br><span class="line">      command: [sh, -c]</span><br><span class="line">      args: [&quot;cowsay hello&quot;]</span><br></pre></td></tr></table></figure>
<p>在 <code>spec</code> 中可以提供 <code>arguments</code> ，來將參數傳進各個<code>step</code> 中。如上面的範例，預設的參數 <code>should-print</code> 為 “false” 而使得直接執行不會執行 whalesay 步驟，但是在執行 workflow 時使用如下指令，便可以動態傳進參數:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">argo submit examples/conditionals.yaml -p should-print=true</span><br></pre></td></tr></table></figure>
<p>而 <code>step</code> 可以使用 <code>NaN</code> 來獲取參數，whalesay這個步驟便會執行。</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>以上便是 Argo 的簡易使用分享，想了解更詳細的使用方法建議直接參考 <a href="https://github.com/argoproj/argo/tree/master/examples" target="_blank" rel="noopener">example</a> 來找到最適合自己的範例。<br>透過 Argo 我們便可以描述 pod 跟 pod 之間的執行順序關係，還可以在彼此之間傳遞結果。<br>因此 <a href="https://github.com/kubeflow/pipelines" target="_blank" rel="noopener">Kubeflow/pipeline</a> 甚至是 Kubeflow 社群的 CI/CD 皆是利用 Argo來完成的。</p>
<p>接下來會利用我自己為 <a href="https://github.com/kubeflow/tf-operator" target="_blank" rel="noopener">Kubeflow/tf-operator</a> 貢獻的 <a href="https://github.com/kubeflow/tf-operator/commit/2788b4d245be919a22b63383441059fc8405ba4e" target="_blank" rel="noopener">e2e test </a> 來描述 Kubeflow 如何用 Argo 實作自己的 CI/CD。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://chanyilin.github.io/OpenStack-oslo-config.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jack Lin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Distributed World">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/OpenStack-oslo-config.html" itemprop="url">OpenStack_oslo_config</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="創建於" itemprop="dateCreated datePublished" datetime="2018-11-15T01:37:25+08:00">
                2018-11-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenStack/" itemprop="url" rel="index">
                    <span itemprop="name">OpenStack</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/OpenStack/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/OpenStack-oslo-config.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="OpenStack-oslo-config.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="OpenStack-Oslo-–-oslo-config"><a href="#OpenStack-Oslo-–-oslo-config" class="headerlink" title="OpenStack Oslo – oslo.config"></a>OpenStack Oslo – oslo.config</h1><hr>
<p>在學習Python的過程中，寫的程式通常是小型的、獨立的、一次性且不牽涉到系統的。<br>但是當我們希望可以寫一個長時間執行的service或是agent。他們是有能力週期性執行任務，並且提供配置文件供使用者客製化設定，甚至可以產生log訊息讓使用者了解程式目前狀況，通常會不知道如何下手。<br>還好我們不必自己摸索，透過Open Source項目我們可以看到世界級的系統軟體是如何被實現的，而裡面通常也有我們要的答案。</p>
<h1 id="什麼是Oslo項目"><a href="#什麼是Oslo項目" class="headerlink" title="什麼是Oslo項目"></a>什麼是Oslo項目</h1><p>在深入了解OpenStack的實作過程中，經常能夠看到程式中import了帶有oslo字樣的模組。<br>是什麼樣的模組可以在OpenStack中每一個服務的實作都會用到呢？<br>這些模組跟Oslo這個項目又有什麼關係？</p>
<p>我們來看看Oslo這個項目的Mission Statement：</p>
<blockquote>
<p>To produce a set of python libraries containing code shared by OpenStack projects. The APIs provided by these libraries should be high quality, stable, consistent, documented and generally applicable.</p>
</blockquote>
<p>也就是說，Oslo這個項目的起源是因為來自世界各地開發OpenStack的大神們，也無法忍受開發過程中不斷的重複製造輪子。<br>特別將經常使用的功能寫成一系列的模組，整合起來成為一個OpenStack中各服務都共享的項目，並且講求質量、穩定度、一致性、擁有完整的文件，最後就是可以廣泛使用。<br>而這一系列的模組，有些如<code>oslo_config</code>可以用來處理命令行參數和配置文件，或是如<code>oslo_service</code>提供了一個開發者創建新的long-running services的框架。</p>
<p>而這也是這一系列文章的目的，我們也許可以透過學習世界級的軟體，來實現心目中想達成的功能，而且最重要的是 — 我們也不用重複製造輪子!</p>
<h1 id="oslo-config"><a href="#oslo-config" class="headerlink" title="oslo_config"></a>oslo_config</h1><p>通常一個大型的系統，為了滿足使用者在不同情境下的需求，會提供許多可以讓使用者更改的配置選項 (Options)。<br>而這些配置選項值的來源有些是從<strong>命令行參數</strong>、有些是來自於一個包含所有配置選項的<strong>配置文件</strong><br>理所當然程式中便需要一個模組來專門處理數量眾多且來源不同的配置選項。而這任務就是交由oslo_config這個模組負責。<br>根據OpenStack Wiki關於oslo_config的說明，該模組負責以下四個任務</p>
<ol>
<li>command line option parsing</li>
<li>common command line options</li>
<li>configuration file parsing</li>
<li>option value lookup</li>
</ol>
<p>透過oslo_config這個模組，我們將有能力從命令行中直接設定配置選項或是從設定檔中讀取配置選項的值。<br>以下我們直接透過實作來瞭解如何使用oslo_config。</p>
<h1 id="環境安裝"><a href="#環境安裝" class="headerlink" title="環境安裝"></a>環境安裝</h1><p>首先，利用virtualenv來創造一個獨立的環境，並安裝oslo_config<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ pip install virtualenv</span><br><span class="line">$ virtualenv example</span><br><span class="line">$ <span class="built_in">cd</span> example</span><br><span class="line">$ <span class="built_in">source</span> bin/activate</span><br><span class="line">$ pip install oslo.config</span><br></pre></td></tr></table></figure></p>
<h1 id="oslo-config使用"><a href="#oslo-config使用" class="headerlink" title="oslo_config使用"></a>oslo_config使用</h1><p>假設一個使用情境，我們今天希望能夠寫一個程式能夠週期性得執行任務，例如：定期對網頁或另一個服務發送請求。這時我們便希望這個程式可以自由設定以下的配置選項：<br>(1).是否執行週期性任務 (2).週期 (3).目標網址 (4).個人帳號 (5).個人密碼<br>那要如何使用oslo_config來幫我們達到這樣的使用情境呢？</p>
<h2 id="配置選項定義"><a href="#配置選項定義" class="headerlink" title="配置選項定義"></a>配置選項定義</h2><p>每一個配置選項有其名稱和對應的值。<br>而oslo_config的配置選項支援以下幾種型態：<br><code>strings</code>, <code>integers</code>, <code>floats</code>, <code>booleans</code>, <code>lists</code>, <code>‘multi strings’</code> ,  <code>‘key/value pairs’ (dictionary)</code></p>
<p>由於配置選項數量龐大，所以勢必要根據他們的性質或是用途來做<strong>分組</strong>，才能讓使用者快速找到他們需要更改的配置選項。<br>我們先將上面五個配置選項分成兩組，分別是periodic_task與request_api，來看oslo_config如何處理。<br>首先我們先創建如下的資目錄結構。<br><em>注： 不在自訂組別內的會被歸類到DEAULT組</em></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">conf</span><br><span class="line">|_  __init__.py</span><br><span class="line">|_  periodic_conf.py //處理 (1)是否執行週期性任務 (2)週期配置</span><br><span class="line">|_  request_conf.py  //處理 (3)目標網址 (4)帳號 (5)密碼</span><br><span class="line">your_app.py</span><br><span class="line">your_app.conf        //配置文件</span><br></pre></td></tr></table></figure>
<p>接下來先從<code>period_conf.py</code>開始看<br>period_conf.py：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> oslo_config <span class="keyword">import</span> cfg</span><br><span class="line"></span><br><span class="line">opt_periodic_task_group = cfg.OptGroup(name=<span class="string">'periodic_task'</span>,</span><br><span class="line">                                       title=<span class="string">'Periodic Tasks Options'</span>)</span><br><span class="line"></span><br><span class="line">periodic_task_opts = [</span><br><span class="line">    cfg.BoolOpt(<span class="string">'periodic_enable'</span>,</span><br><span class="line">                default=<span class="keyword">True</span>,</span><br><span class="line">                help=<span class="string">'Enable periodic tasks.'</span>),</span><br><span class="line"></span><br><span class="line">    cfg.IntOpt(<span class="string">'periodic_interval'</span>,</span><br><span class="line">                default=<span class="number">60</span>,</span><br><span class="line">                help=<span class="string">'Max interval size between periodic tasks'</span></span><br><span class="line">                     <span class="string">'execution in seconds.'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>首先我們需要先從oslo_config中引入cfg模組，<br>並且透過cfg.OptGroup函式來定義一個配置選項組opt_periodic_task_group，<br>同時給予name與title。</p>
<p>接下來，我們定義兩個配置選項並包在一個名為periodic_task_opts的list中，分別是<br>periodic_enable、periodic_interval。<br>這邊可以看到透過cfg.BoolOpt等函式我們可以設定該配置選項的名稱、預設值、提示…等。<br>其他變數類型也有相對應的函式。</p>
<h2 id="註冊配置選項"><a href="#註冊配置選項" class="headerlink" title="註冊配置選項"></a>註冊配置選項</h2><p>period_conf.py：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_opts</span><span class="params">(conf)</span>:</span></span><br><span class="line">    conf.register_group(opt_periodic_task_group)</span><br><span class="line"></span><br><span class="line">    conf.register_cli_opts(periodic_task_opts,opt_periodic_task_group)</span><br><span class="line">    conf.register_opts(periodic_task_opts, opt_periodic_task_group)</span><br></pre></td></tr></table></figure></p>
<p>延續上面的程式碼，在<code>period_conf.py</code>中寫一個register_opts的函式，負責將我們的配置選項註冊到conf變數中，這邊可以看到有三種函式：</p>
<ul>
<li>register_group: 第一步驟是將group的定義註冊。</li>
<li>register_cli_opts: 如果希望能夠在命令行設定配置參數，則利用此函式註冊配置選項</li>
<li>register_opts: 若是希望透過配置文件來設定參數，則利用此函式註冊配置選項。</li>
</ul>
<p>最後，我們需要再寫一個<code>__init__.py</code>，目的是讓<code>conf</code>這個資料被做為一個模組，並且在裡面將所有不同組別的配置選項做統一的註冊。<br>下面附上<code>__init__.py</code>、<code>period_conf.py</code>、<code>request_conf.py</code>完整程式碼。</p>
<p>＿init＿.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> oslo_config <span class="keyword">import</span> cfg</span><br><span class="line"><span class="keyword">import</span> period_conf</span><br><span class="line"><span class="keyword">import</span> request_conf</span><br><span class="line"></span><br><span class="line">CONF = cfg.CONF</span><br><span class="line"></span><br><span class="line">period_conf.register_opts(CONF)</span><br><span class="line">request_conf.register_opts(CONF)</span><br></pre></td></tr></table></figure></p>
<p>period_conf.py：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> oslo_config <span class="keyword">import</span> cfg</span><br><span class="line"></span><br><span class="line">opt_periodic_task_group = cfg.OptGroup(name=<span class="string">'periodic_task'</span>,</span><br><span class="line">                                       title=<span class="string">'Periodic Tasks Options'</span>)</span><br><span class="line">                                       </span><br><span class="line">periodic_task_opts = [</span><br><span class="line">    cfg.BoolOpt(<span class="string">'periodic_enable'</span>,</span><br><span class="line">                default=<span class="keyword">True</span>,</span><br><span class="line">                help=<span class="string">'Enable periodic tasks.'</span>),</span><br><span class="line"></span><br><span class="line">    cfg.IntOpt(<span class="string">'periodic_interval'</span>,</span><br><span class="line">                default=<span class="number">60</span>,</span><br><span class="line">                help=<span class="string">'Max interval size between periodic tasks'</span></span><br><span class="line">                     <span class="string">'execution in seconds.'</span>),</span><br><span class="line">]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_opts</span><span class="params">(conf)</span>:</span></span><br><span class="line">    conf.register_group(opt_periodic_task_group)</span><br><span class="line"></span><br><span class="line">    conf.register_cli_opts(periodic_task_opts,opt_periodic_task_group)</span><br><span class="line">    conf.register_opts(periodic_task_opts, opt_periodic_task_group)</span><br></pre></td></tr></table></figure></p>
<p>request_conf.py：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> oslo_config <span class="keyword">import</span> cfg</span><br><span class="line"></span><br><span class="line">opt_request_api_group = cfg.OptGroup(name=<span class="string">'request_api'</span>,</span><br><span class="line">                                     title=<span class="string">'Request Api Options'</span>)</span><br><span class="line">                                     </span><br><span class="line">request_api_opts = [</span><br><span class="line">    cfg.StrOpt(<span class="string">'host'</span>,</span><br><span class="line">               default=<span class="string">'localhost'</span>,</span><br><span class="line">               help=<span class="string">'IP/hostname'</span>),</span><br><span class="line"></span><br><span class="line">    cfg.ListOpt(<span class="string">'username'</span>,</span><br><span class="line">                default=<span class="keyword">None</span>,</span><br><span class="line">                help=<span class="string">'A list of usernames'</span>),</span><br><span class="line"></span><br><span class="line">    cfg.DictOpt(<span class="string">'password'</span>,</span><br><span class="line">                default=<span class="keyword">None</span>,</span><br><span class="line">                help=<span class="string">'password for each usernames'</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_opts</span><span class="params">(conf)</span>:</span></span><br><span class="line">    conf.register_group(opt_request_api_group)</span><br><span class="line">    conf.register_opts(request_api_opts, opt_request_api_group</span><br></pre></td></tr></table></figure></p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>現在讓我們看一下配置文件內部的格式<br>your_app.conf:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[request_api]</span><br><span class="line">host = localhost                    //strings</span><br><span class="line">username = Jack, John               //lists</span><br><span class="line">password = Jack: XXXX, John: YYYY   //dictionary</span><br><span class="line"></span><br><span class="line">[periodic_task]</span><br><span class="line">periodic_enable = False             //booleans</span><br><span class="line">periodic_interval = 20              //integers</span><br></pre></td></tr></table></figure></p>
<p>還記得我們剛剛在宣告組別的時候給了name嗎?<br>當時定義的name在配置文件中就是用來表示不同的group。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>終於來到最後在我們自己的程式中取用這些配置的參數。<br>your_app.py:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> conf  //將我們的conf資料夾作為模組<span class="keyword">import</span></span><br><span class="line"><span class="keyword">import</span> sys   </span><br><span class="line"></span><br><span class="line">CONF = conf.CONF</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    CONF(sys.argv[<span class="number">1</span>:], project=<span class="string">'your_app'</span>)</span><br><span class="line"></span><br><span class="line">    print( CONF.request_api.host )</span><br><span class="line">    print( CONF.request_api.username[<span class="number">0</span>])</span><br><span class="line">    print( CONF.request_api.password[<span class="string">'Jack'</span>] )</span><br><span class="line"></span><br><span class="line">    print( CONF.periodic_task.periodic_enable )</span><br><span class="line">    print( CONF.periodic_task.periodic_interval )</span><br></pre></td></tr></table></figure></p>
<p>首先這邊有幾個重點：</p>
<ol>
<li><p>可以看到CONF以全域變數的角色存在，這點在OpenStack community是一個爭執很久的議題。有興趣的可以至下面連結看開發者們的結論。<br><a href="https://wiki.openstack.org/wiki/Oslo#Why_does_oslo.config_have_a_CONF_object.3F_Global_object_SUCK.21" target="_blank" rel="noopener">Why does oslo.config have a CONF object? Global object SUCK!</a></p>
</li>
<li><p>CONF透過命令行參數來找到配置文件位置，那第一行為什麼需要<code>project=&#39;your_app&#39;</code>呢？<br>這是因為在oslo_config設計中，如果沒有指定參數的話，預設會到<code>/etc/project</code>來尋找配置文件。以這邊的例子來說就會至<code>/etc/your_app/</code>底下尋找。</p>
</li>
</ol>
<p>最後執行<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python your_app.py --config-file your_app.conf</span><br></pre></td></tr></table></figure></p>
<p>即可看到你在配置文件中配置的參數。</p>
<p>等等，那如果我希望能夠從命令行來指定配置參數的話該如何做呢？<br>首先我們可以透過<code>-h</code>來看命令行參數可以設定哪些配置，以及每個參數的說明。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ python your_app.py -h</span><br><span class="line"></span><br><span class="line">usage: your_app [-h] [--config-dir DIR] [--config-file PATH]</span><br><span class="line">                [--periodic_task-noperiodic_enable]</span><br><span class="line">                [--periodic_task-periodic_enable]</span><br><span class="line">                [--periodic_task-periodic_interval PERIODIC_TASK_PERIODIC_INTERVAL]</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --<span class="built_in">help</span>            show this <span class="built_in">help</span> message and <span class="built_in">exit</span></span><br><span class="line">  --config-dir DIR      Path to a config directory to pull *.conf files from.</span><br><span class="line">                        This file <span class="built_in">set</span> is sorted, so as to provide a</span><br><span class="line">                        predictable parse order <span class="keyword">if</span> individual options are</span><br><span class="line">                        over-ridden. The <span class="built_in">set</span> is parsed after the file(s)</span><br><span class="line">                        specified via previous --config-file, arguments hence</span><br><span class="line">                        over-ridden options <span class="keyword">in</span> the directory take precedence.</span><br><span class="line">  --config-file PATH    Path to a config file to use. Multiple config files</span><br><span class="line">                        can be specified, with values <span class="keyword">in</span> later files taking</span><br><span class="line">                        precedence. Defaults to None.</span><br><span class="line"></span><br><span class="line">Periodic Tasks Options:</span><br><span class="line">  --periodic_task-noperiodic_enable</span><br><span class="line">                        The inverse of --periodic_enable</span><br><span class="line">  --periodic_task-periodic_enable</span><br><span class="line">                        Enable periodic tasks.</span><br><span class="line">  --periodic_task-periodic_interval PERIODIC_TASK_PERIODIC_INTERVAL</span><br><span class="line">                        Max interval size between periodic tasks execution <span class="keyword">in</span></span><br><span class="line">                        seconds.</span><br></pre></td></tr></table></figure>
<p>這時在透過以下指令，即可在命令行中指定配置參數。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python your_app.py --config-file your_app.conf --periodic_task-periodic_interval 1000</span><br></pre></td></tr></table></figure>
<p>以上，即是最簡單但也是最核心的<code>Oslo_config</code>使用方法。</p>
<h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><p>1.<a href="https://wiki.openstack.org/wiki/Oslo" target="_blank" rel="noopener">https://wiki.openstack.org/wiki/Oslo</a> Oslo WiKi<br>2.<a href="https://wiki.openstack.org/wiki/Oslo/Config" target="_blank" rel="noopener">https://wiki.openstack.org/wiki/Oslo/Config</a> Oslo.config WiKi<br>3.<a href="https://github.com/openstack/magnum" target="_blank" rel="noopener">https://github.com/openstack/magnum</a> OpenStack Magnum Source code<br>4.<a href="http://www.choudan.net/2013/11/27/OpenStack-Oslo.config-%E5%AD%A6%E4%B9%A0(%E4%B8%80).html" target="_blank" rel="noopener">http://www.choudan.net/2013/11/27/OpenStack-Oslo.config-%E5%AD%A6%E4%B9%A0(%E4%B8%80).html</a><br>5.<a href="http://gtcsq.readthedocs.io/en/latest/openstack/oslo_cfg.html" target="_blank" rel="noopener">http://gtcsq.readthedocs.io/en/latest/openstack/oslo_cfg.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/me.jpg" alt="Jack Lin">
            
              <p class="site-author-name" itemprop="name">Jack Lin</p>
              <p class="site-description motion-element" itemprop="description">目前任職於 InfuseAI. 專注於Kubeflow與Kubernetes. 同時也是 Kubeflow member與Kubeflow/tf-operator reviewer.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">文章</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">分類</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">標籤</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/ChanYiLin" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.linkedin.com/in/jack-lin-a43506a2/" target="_blank" title="Linkedin">
                      
                        <i class="fa fa-fw fa-linkedin"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.facebook.com/yourname" target="_blank" title="FB Page">
                      
                        <i class="fa fa-fw fa-facebook"></i></a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jack Lin</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" rel="external nofollow" target="_blank" href="https://hexo.io">Hexo</a> 強力驅動</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主題 &mdash; <a class="theme-link" rel="external nofollow" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://jacklinblog-1.disqus.com/count.js" async></script>
    

    

  




	





  














  





  

  

  

  
  

  

  

  

</body>
</html>
