<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-58777369-2', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
  <title>Argo | Distributed World</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Kubeflow 作為一個 Deep Learning service on Kubernetes 的專案，自然面對最大的問題就是如何將一個 DL 中的每一個 phase 串在一起。而眾多 workflow 工具中， Kubeflow 在這邊選擇使用的便是 - Argo。 Kubeflow 不只將 Argo 應用在 pipeline，也應用在它內部的CI/CD上，因此值得我們好好關注。 Argo">
<meta name="keywords" content="Kubeflow,Kubernetes,Workflow,argo">
<meta property="og:type" content="article">
<meta property="og:title" content="Argo">
<meta property="og:url" content="https://chanyilin.github.io/argo.html">
<meta property="og:site_name" content="Distributed World">
<meta property="og:description" content="Kubeflow 作為一個 Deep Learning service on Kubernetes 的專案，自然面對最大的問題就是如何將一個 DL 中的每一個 phase 串在一起。而眾多 workflow 工具中， Kubeflow 在這邊選擇使用的便是 - Argo。 Kubeflow 不只將 Argo 應用在 pipeline，也應用在它內部的CI/CD上，因此值得我們好好關注。 Argo">
<meta property="og:locale" content="zh-tw">
<meta property="og:image" content="https://chanyilin.github.io/images/argo.png">
<meta property="og:image" content="https://chanyilin.github.io/images/argo-ui.png">
<meta property="og:image" content="https://chanyilin.github.io/images/dag-steps-cmp.png">
<meta property="og:updated_time" content="2019-11-27T04:12:10.484Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Argo">
<meta name="twitter:description" content="Kubeflow 作為一個 Deep Learning service on Kubernetes 的專案，自然面對最大的問題就是如何將一個 DL 中的每一個 phase 串在一起。而眾多 workflow 工具中， Kubeflow 在這邊選擇使用的便是 - Argo。 Kubeflow 不只將 Argo 應用在 pipeline，也應用在它內部的CI/CD上，因此值得我們好好關注。 Argo">
<meta name="twitter:image" content="https://chanyilin.github.io/images/argo.png">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Distributed World</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://chanyilin.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-argo" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/argo.html" class="article-date">
  <time datetime="2019-02-06T17:24:27.000Z" itemprop="datePublished">2019-02-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Kubeflow/">Kubeflow</a>►<a class="article-category-link" href="/categories/Kubeflow/Kubernetes/">Kubernetes</a>►<a class="article-category-link" href="/categories/Kubeflow/Kubernetes/Workflow/">Workflow</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Argo
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/argo.png" alt="argo"></p>
<p>Kubeflow 作為一個 Deep Learning service on Kubernetes 的專案，自然面對最大的問題就是如何將一個 DL 中的每一個 phase 串在一起。而眾多 workflow 工具中， Kubeflow 在這邊選擇使用的便是 - <code>Argo</code>。 Kubeflow 不只將 Argo 應用在 pipeline，也應用在它內部的CI/CD上，因此值得我們好好關注。</p>
<p>Argo 是一個基於 CRD 實作的一個 Workflow 工具，協助使用者管理與控制一系列任務的執行，<br>同時提供一個簡潔的UI介面觀看每一個任務的執行狀況、順序、結果與 log。<br>由於 Workflow 本身是一個 CRD，因此建立 workflow 的方法也是透過撰寫一個 yaml 檔，而 Argo 也針對如何描述一個 workflow 提供了許多的規則。</p>
<h2 id="部署Argo"><a href="#部署Argo" class="headerlink" title="部署Argo"></a>部署Argo</h2><p>我們這邊是獨立部署，如果是直接安裝Kubeflow，以下這些components已經安裝完畢，只需另外安裝argo client即可。</p>
<ol>
<li><p>首先下載安裝Argo client<br> Mac:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install argoproj/tap/argo</span><br></pre></td></tr></table></figure>
<p> Linux:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL -o /usr/local/bin/argo https://github.com/argoproj/argo/releases/download/v2.2.1/argo-linux-amd64</span><br><span class="line">chmod +x /usr/local/bin/argo</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下來安裝Argo Controller 與 UI</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns argo</span><br><span class="line">kubectl apply -n argo -f https://raw.githubusercontent.com/argoproj/argo/v2.2.1/manifests/install.yaml</span><br></pre></td></tr></table></figure>
<p> <strong>NOTE: 因為上面的insall.yaml會需要在你的k8s中創建clusterrole。因此如果使用的是GKE，這邊需要特別開通權限。</strong></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding YOURNAME-cluster-admin-binding --clusterrole=cluster-admin --user=YOUREMAIL@gmail.com</span><br></pre></td></tr></table></figure>
<p> 安裝好後就會在k8s下面的argo namespace看到以下的components</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">NAME                         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deploy/argo-ui               1         1         1            1           84d</span><br><span class="line">deploy/workflow-controller   1         1         1            1           84d</span><br><span class="line"></span><br><span class="line">NAME                               DESIRED   CURRENT   READY     AGE</span><br><span class="line">rs/argo-ui-65bb8cf7f6              1         1         1         35s</span><br><span class="line">rs/argo-ui-6bb9c4485f              0         0         0         84d</span><br><span class="line">rs/workflow-controller-7f4dd6bd9   0         0         0         84d</span><br><span class="line">rs/workflow-controller-8fb5fb5d5   1         1         1         33s</span><br><span class="line"></span><br><span class="line">NAME                                     READY     STATUS        RESTARTS   AGE</span><br><span class="line">po/argo-ui-65bb8cf7f6-q2r59              1/1       Running       0          35s</span><br><span class="line">po/argo-ui-6bb9c4485f-7v2d5              1/1       Terminating   0          42d</span><br><span class="line">po/workflow-controller-8fb5fb5d5-spq99   1/1       Running       0          33s</span><br><span class="line"></span><br><span class="line">NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">svc/argo-ui   ClusterIP   10.27.255.240   &lt;none&gt;        80/TCP    84d</span><br></pre></td></tr></table></figure>
</li>
<li><p>在接下來使用Argo的過程中，default account的權限會限制一些功能，因此我們這邊在default account綁上admin privileges。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create rolebinding default-admin --clusterrole=admin --serviceaccount=default:default</span><br></pre></td></tr></table></figure>
<p> 也可以在執行的workflow時指定使用的是哪一個service account</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">argo submit --serviceaccount &lt;name&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>以上即完成Argo的部署。</p>
<h2 id="使用Argo-UI"><a href="#使用Argo-UI" class="headerlink" title="使用Argo UI"></a>使用Argo UI</h2><p>Argo UI 可以讓使用者輕鬆關觀察一個 workflow 的狀況，並檢查每一個步驟的結果與錯誤訊息。</p>
<p><strong>kubectl port-forward</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n argo port-forward deployment/argo-ui 8001:8001</span><br></pre></td></tr></table></figure></p>
<p>透過 <a href="http://127.0.0.1:8001" target="_blank" rel="noopener">http://127.0.0.1:8001</a> 使用</p>
<p><strong>Method 2: kubectl proxy</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy</span><br></pre></td></tr></table></figure></p>
<p>透過  <a href="http://127.0.0.1:8001/api/v1/namespaces/argo/services/argo-ui/proxy/" target="_blank" rel="noopener">http://127.0.0.1:8001/api/v1/namespaces/argo/services/argo-ui/proxy/</a> 使用</p>
<p><strong>Expose a LoadBalancer</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch svc argo-ui -n argo -p &apos;&#123;&quot;spec&quot;: &#123;&quot;type&quot;: &quot;LoadBalancer&quot;&#125;&#125;&apos;</span><br><span class="line"></span><br><span class="line">kubectl get svc argo-ui -n argo</span><br><span class="line">NAME      TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)        AGE</span><br><span class="line">argo-ui   LoadBalancer   10.19.255.205   35.197.49.167   80:30999/TCP   1m</span><br></pre></td></tr></table></figure></p>
<p>結果如下圖：</p>
<p><img src="/images/argo-ui.png" alt="argo-ui"></p>
<h2 id="Argo-範例與解析"><a href="#Argo-範例與解析" class="headerlink" title="Argo 範例與解析"></a>Argo 範例與解析</h2><p>如同上面所說，Argo 也是透過自己實作一個 operator(CRD + controller) 來完成 Workflow 的功能。而所謂的在 k8s 中執行 workflow 的意思便是利用一個個 pod 來執行我們的每一個步驟。</p>
<p>因此我們這邊先來看幾個簡單的 argo crd，看看我們能設定哪些參數及能做到哪些事情。</p>
<p>首先提供一些常用的指令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">argo list #查看有哪些 workflow</span><br><span class="line">argo get xxx-workflow-name-xxx #查看這個 workflow 的狀態</span><br><span class="line">argo logs xxx-pod-name-xxx #查看這個 pod 的 output</span><br></pre></td></tr></table></figure></p>
<h3 id="coinflip"><a href="#coinflip" class="headerlink" title="coinflip"></a>coinflip</h3><p>這個範例的目標是，先丟一個硬幣，如果是 head 就執行 head 的工作，如果是 tail 就執行 tail 的工作。也就是 workflow 最基礎的 if-else 功能。</p>
<p>首先先利用以下指令來執行coinflip worklow：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">argo submit --watch https://raw.githubusercontent.com/argoproj/argo/master/examples/coinflip.yaml</span><br></pre></td></tr></table></figure></p>
<p>接著我們來分析中間發生了哪些事：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Name:                coinflip-czw7h</span><br><span class="line">Namespace:           default</span><br><span class="line">ServiceAccount:      default</span><br><span class="line">Status:              Succeeded</span><br><span class="line">Created:             Wed Feb 06 23:07:02 +0100 (38 seconds ago)</span><br><span class="line">Started:             Wed Feb 06 23:07:02 +0100 (38 seconds ago)</span><br><span class="line">Finished:            Wed Feb 06 23:07:40 +0100 (now)</span><br><span class="line">Duration:            38 seconds</span><br><span class="line"></span><br><span class="line">STEP               PODNAME                    DURATION  MESSAGE</span><br><span class="line"> ✔ coinflip-czw7h</span><br><span class="line"> ├---✔ flip-coin   coinflip-czw7h-3048772414  23s</span><br><span class="line"> └-·-○ heads                                            when &apos;tails == heads&apos; evaluated false</span><br><span class="line">   └-✔ tails       coinflip-czw7h-3790732747  13s</span><br></pre></td></tr></table></figure>
<p>這是你會看到的介面。上面呈現了一些基本的訊息，以及這個 workflow 每一個 steps 發生的事情與執行了哪個相對應得 pod。</p>
<p>因此問題便是，我們如何讓每一個 pod 知道上一步驟的結果，與如何傳遞結果給下一個步驟。</p>
<p>我們現在來細看這個coinflips到底怎麼做的，以下是他的yaml file：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: Workflow</span><br><span class="line">metadata:</span><br><span class="line">  generateName: coinflip-</span><br><span class="line">spec:</span><br><span class="line">  entrypoint: coinflip</span><br><span class="line">  templates:</span><br><span class="line">  - name: coinflip</span><br><span class="line">    steps:</span><br><span class="line">    - - name: flip-coin</span><br><span class="line">        template: flip-coin</span><br><span class="line">    - - name: heads</span><br><span class="line">        template: heads</span><br><span class="line">        when: &quot;&#123;&#123;steps.flip-coin.outputs.result&#125;&#125; == heads&quot;</span><br><span class="line">      - name: tails</span><br><span class="line">        template: tails</span><br><span class="line">        when: &quot;&#123;&#123;steps.flip-coin.outputs.result&#125;&#125; == tails&quot;</span><br><span class="line"></span><br><span class="line">  - name: flip-coin</span><br><span class="line">    script:</span><br><span class="line">      image: python:alpine3.6</span><br><span class="line">      command: [python]</span><br><span class="line">      source: |</span><br><span class="line">        import random</span><br><span class="line">        result = &quot;heads&quot; if random.randint(0,1) == 0 else &quot;tails&quot;</span><br><span class="line">        print(result)</span><br><span class="line"></span><br><span class="line">  - name: heads</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.6</span><br><span class="line">      command: [sh, -c]</span><br><span class="line">      args: [&quot;echo \&quot;it was heads\&quot;&quot;]</span><br><span class="line"></span><br><span class="line">  - name: tails</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.6</span><br><span class="line">      command: [sh, -c]</span><br><span class="line">      args: [&quot;echo \&quot;it was tails\&quot;&quot;]</span><br></pre></td></tr></table></figure>
<p>從上面可以很簡單知道：</p>
<ul>
<li><code>apiVersion: argoproj.io/v1alpha1</code> 與 <code>kind: Workflow</code> 說明了這是一個CRD</li>
<li><code>spec</code> 從 <code>entrypoing</code> 開始執行，在這邊即是從 <code>coinflip</code> 這個 <code>template</code> 開始</li>
<li><code>templates</code> 裡面的每一項描述的都是一個工作，包含<ul>
<li>名字</li>
<li>可以執行一個 <code>container</code> 或是執行 <code>script</code></li>
<li>container <code>image</code></li>
<li><code>command</code> 與 <code>args</code></li>
<li><code>steps</code> : 作用是排定一系列 <code>templates</code> 執行的先後順序</li>
</ul>
</li>
<li>coinflip 同時作為一個 <code>entrypoint</code> ，特別可以看到他裡面描述的是 <code>steps</code> ，且包含：<ul>
<li>每一步驟的名字</li>
<li>要執行的 <code>template</code></li>
<li>什麼時候執行</li>
</ul>
</li>
</ul>
<p>將上面的 yaml 轉成 json 可以視為[[flip-coin], [heads, tails]]，因此會先執行 flip-coin。而 flip-coin 透過執行的 <code>script</code> 會有一個 result 作為 output，表示擲出硬幣的結果。<br>而下面的步驟透過 <code>NaN</code> 來獲得特定步驟的 output 作為判斷的依據，進而可以達成 if-else 的workflow效果 。</p>
<p>Ref: 可另外參考 <a href="https://raw.githubusercontent.com/argoproj/argo/master/examples/coinflip-recursive.yaml" target="_blank" rel="noopener">coinflip-recursive</a></p>
<h3 id="dag-diamond"><a href="#dag-diamond" class="headerlink" title="dag-diamond"></a>dag-diamond</h3><p>在一個 workflow 中除了 <code>if-else</code> 外，有時也需要能夠表達工作之間的相依性，或是有時一些工作需要可以平行執行。而 Argo 便提供 <code>dag</code> 來描述工作的相依性，直接看範例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: Workflow</span><br><span class="line">metadata:</span><br><span class="line">  generateName: dag-diamond-</span><br><span class="line">spec:</span><br><span class="line">  entrypoint: diamond</span><br><span class="line">  templates:</span><br><span class="line">  - name: diamond</span><br><span class="line">    dag:</span><br><span class="line">      tasks:</span><br><span class="line">      - name: A</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: A&#125;]</span><br><span class="line">      - name: B</span><br><span class="line">        dependencies: [A]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: B&#125;]</span><br><span class="line">      - name: C</span><br><span class="line">        dependencies: [A]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: C&#125;]</span><br><span class="line">      - name: D</span><br><span class="line">        dependencies: [B, C]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: D&#125;]</span><br><span class="line"></span><br><span class="line">  - name: echo</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">      - name: message</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.7</span><br><span class="line">      command: [echo, &quot;&#123;&#123;inputs.parameters.message&#125;&#125;&quot;]</span><br></pre></td></tr></table></figure>
<p>可以注意到這邊沒有使用<code>steps</code>，而是使用<code>dag</code>。在<code>dag</code>中的每一項步驟皆可以使用<code>dependencies</code>來描述相依的工作，比方說 B,C 步驟便強迫要在 A 完成後才能執行。而當 A 完成後，B,C 滿足條件便會同時（平行）執行，最後才交由 D 執行。</p>
<p>透過 <code>dag</code> 便可以編排出工作的順序與相依性，或是讓工作平行執行。</p>
<h4 id="dag-與-steps"><a href="#dag-與-steps" class="headerlink" title="dag 與 steps"></a>dag 與 steps</h4><p>還記得剛剛的 flip-coin 範例嗎，透過steps也可以達成某程度的平行執行或是順序執行，但是無法表達相依性。什麼意思呢？</p>
<p>熟悉 yaml 的人應該會知道 yaml 跟 json 是等價可以互相轉換的，而 yaml 中的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">steps:</span><br><span class="line">    - - name: flip-coin</span><br><span class="line">        template: flip-coin</span><br><span class="line">    - - name: heads</span><br><span class="line">        template: heads</span><br><span class="line">        when: &quot;&#123;&#123;steps.flip-coin.outputs.result&#125;&#125; == heads&quot;</span><br><span class="line">      - name: tails</span><br><span class="line">        template: tails</span><br><span class="line">        when: &quot;&#123;&#123;steps.flip-coin.outputs.result&#125;&#125; == tails&quot;</span><br></pre></td></tr></table></figure>
<p>中間的 <code>- -</code> 表達的是 <em>list中的list</em> 的意思，也就是 [[flip-coin], [heads, tails]]。當 steps 再寫的時候如果是依序執行一律用<code>- -</code>，若是在同一個 list 內則會平行執行。</p>
<p>因此以下用一個例子比較：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  entrypoint: diamond</span><br><span class="line">  templates:</span><br><span class="line">  - name: diamond</span><br><span class="line">    steps:</span><br><span class="line">    - - name: A</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: A&#125;]</span><br><span class="line">    - - name: B</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: B&#125;]</span><br><span class="line">      - name: C</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: C&#125;]</span><br><span class="line">    - - name: D</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: D&#125;]</span><br><span class="line"></span><br><span class="line">  - name: echo</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">      - name: message</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.7</span><br><span class="line">      command: [echo, &quot;&#123;&#123;inputs.parameters.message&#125;&#125;&quot;]</span><br></pre></td></tr></table></figure></p>
<p>是等價於<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  entrypoint: diamond</span><br><span class="line">  templates:</span><br><span class="line">  - name: diamond</span><br><span class="line">    dag:</span><br><span class="line">      tasks:</span><br><span class="line">      - name: A</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: A&#125;]</span><br><span class="line">      - name: B</span><br><span class="line">        dependencies: [A]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: B&#125;]</span><br><span class="line">      - name: C</span><br><span class="line">        dependencies: [A]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: C&#125;]</span><br><span class="line">      - name: D</span><br><span class="line">        dependencies: [B, C]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: D&#125;]</span><br><span class="line"></span><br><span class="line">  - name: echo</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">      - name: message</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.7</span><br><span class="line">      command: [echo, &quot;&#123;&#123;inputs.parameters.message&#125;&#125;&quot;]</span><br></pre></td></tr></table></figure></p>
<p>如下圖透過UI看到的結果：</p>
<p><img src="/images/dag-steps-cmp.png" alt="dag-steps-cmp"></p>
<h3 id="conditionals"><a href="#conditionals" class="headerlink" title="conditionals"></a>conditionals</h3><p>了解了上面如何實現 <code>if-else</code> ,<code>依序執行</code>, <code>同時執行</code>後，最後在看一個範例解釋了如何在 workflow 執行時動態的給予參數，並影響結果，我們直接看yaml file：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: Workflow</span><br><span class="line">metadata:</span><br><span class="line">  generateName: conditional-</span><br><span class="line">spec:</span><br><span class="line">  entrypoint: conditional-example</span><br><span class="line">  arguments:</span><br><span class="line">    parameters:</span><br><span class="line">    - name: should-print</span><br><span class="line">      value: &quot;false&quot;</span><br><span class="line"></span><br><span class="line">  templates:</span><br><span class="line">  - name: conditional-example</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">      - name: should-print</span><br><span class="line">    steps:</span><br><span class="line">    - - name: print-hello</span><br><span class="line">        template: whalesay</span><br><span class="line">        when: &quot;&#123;&#123;inputs.parameters.should-print&#125;&#125; == true&quot;</span><br><span class="line"></span><br><span class="line">  - name: whalesay</span><br><span class="line">    container:</span><br><span class="line">      image: docker/whalesay:latest</span><br><span class="line">      command: [sh, -c]</span><br><span class="line">      args: [&quot;cowsay hello&quot;]</span><br></pre></td></tr></table></figure>
<p>在 <code>spec</code> 中可以提供 <code>arguments</code> ，來將參數傳進各個<code>step</code> 中。如上面的範例，預設的參數 <code>should-print</code> 為 “false” 而使得直接執行不會執行 whalesay 步驟，但是在執行 workflow 時使用如下指令，便可以動態傳進參數:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">argo submit examples/conditionals.yaml -p should-print=true</span><br></pre></td></tr></table></figure>
<p>而 <code>step</code> 可以使用 <code>NaN</code> 來獲取參數，whalesay這個步驟便會執行。</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>以上便是 Argo 的簡易使用分享，想了解更詳細的使用方法建議直接參考 <a href="https://github.com/argoproj/argo/tree/master/examples" target="_blank" rel="noopener">example</a> 來找到最適合自己的範例。<br>透過 Argo 我們便可以描述 pod 跟 pod 之間的執行順序關係，還可以在彼此之間傳遞結果。<br>因此 <a href="https://github.com/kubeflow/pipelines" target="_blank" rel="noopener">Kubeflow/pipeline</a> 甚至是 Kubeflow 社群的 CI/CD 皆是利用 Argo來完成的。</p>
<p>接下來會利用我自己為 <a href="https://github.com/kubeflow/tf-operator" target="_blank" rel="noopener">Kubeflow/tf-operator</a> 貢獻的 <a href="https://github.com/kubeflow/tf-operator/commit/2788b4d245be919a22b63383441059fc8405ba4e" target="_blank" rel="noopener">e2e test </a> 來描述 Kubeflow 如何用 Argo 實作自己的 CI/CD。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://chanyilin.github.io/argo.html" data-id="ck41d2vwc00023e4pk3v155ve" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kubeflow/">Kubeflow</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kubernetes/">Kubernetes</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Workflow/">Workflow</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/argo/">argo</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/kubeflow-istio-authnz.html" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Kubeflow如何搭配Istio實作Multi-user認證與權限管理(上)
        
      </div>
    </a>
  
  
    <a href="/OpenStack-oslo-config.html" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">OpenStack_oslo_config</div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Jack Lin<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>



<script src="/js/script.js"></script>



  </div>
</body>
</html>