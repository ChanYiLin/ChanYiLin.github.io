<!DOCTYPE html>





<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"right","display":"always","offset":12,"onmobile":true},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Argo 是一個基於 CRD 實作的一個 Workflow 工具，協助使用者管理與控制一系列任務的執行，同時提供一個簡潔的UI介面觀看每一個任務的執行狀況、順序、結果與 log。">
<meta name="keywords" content="Kubeflow,部署,安裝,Kubernetes,argo,Argo">
<meta property="og:type" content="article">
<meta property="og:title" content="Argo">
<meta property="og:url" content="https://chanyilin.github.io/argo.html">
<meta property="og:site_name" content="Distributed World">
<meta property="og:description" content="Argo 是一個基於 CRD 實作的一個 Workflow 工具，協助使用者管理與控制一系列任務的執行，同時提供一個簡潔的UI介面觀看每一個任務的執行狀況、順序、結果與 log。">
<meta property="og:locale" content="zh-tw">
<meta property="og:image" content="https://chanyilin.github.io/images/argo.png">
<meta property="og:image" content="https://chanyilin.github.io/images/argo-ui.png">
<meta property="og:image" content="https://chanyilin.github.io/images/dag-steps-cmp.png">
<meta property="og:updated_time" content="2019-12-14T02:47:57.608Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Argo">
<meta name="twitter:description" content="Argo 是一個基於 CRD 實作的一個 Workflow 工具，協助使用者管理與控制一系列任務的執行，同時提供一個簡潔的UI介面觀看每一個任務的執行狀況、順序、結果與 log。">
<meta name="twitter:image" content="https://chanyilin.github.io/images/argo.png">
  <link rel="canonical" href="https://chanyilin.github.io/argo">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Argo | Distributed World</title>
  <meta name="generator" content="Hexo 3.8.0">
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-tw">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Distributed World</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Jack's Blog</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>Home</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-about">
      
    

    <a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>About</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    

    <a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>Tags</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>Categories</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>Archives</a>

  </li>
  </ul>

    

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
      <article itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block post">
    <link itemprop="mainEntityOfPage" href="https://chanyilin.github.io/argo.html">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jack Lin">
      <meta itemprop="description" content="目前任職於 InfuseAI. 專注於Kubeflow與Kubernetes. 同時也是 Kubeflow member與Kubeflow/tf-operator reviewer.">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Distributed World">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Argo

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              
                
              

              <time title="Created: 2019-02-07 01:24:27" itemprop="dateCreated datePublished" datetime="2019-02-07T01:24:27+08:00">2019-02-07</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-12-14 10:47:57" itemprop="dateModified" datetime="2019-12-14T10:47:57+08:00">2019-12-14</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Kubeflow/" itemprop="url" rel="index"><span itemprop="name">Kubeflow</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Kubeflow/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Kubeflow/Kubernetes/Pipeline/" itemprop="url" rel="index"><span itemprop="name">Pipeline</span></a></span>

                
                
              
            </span>
          

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
        
      
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/argo.html#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="argo.html" itemprop="commentCount"></span></a>
  </span>
  
  
            <div class="post-description">Argo 是一個基於 CRD 實作的一個 Workflow 工具，協助使用者管理與控制一系列任務的執行，同時提供一個簡潔的UI介面觀看每一個任務的執行狀況、順序、結果與 log。</div>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><img src="/images/argo.png" alt="argo"></p>
<p>Kubeflow 作為一個 Deep Learning service on Kubernetes 的專案，自然面對最大的問題就是如何將一個 DL 中的每一個 phase 串在一起。而眾多 workflow 工具中， Kubeflow 在這邊選擇使用的便是 - <code>Argo</code>。 Kubeflow 不只將 Argo 應用在 pipeline，也應用在它內部的CI/CD上，因此值得我們好好關注。</p>
<p>Argo 是一個基於 CRD 實作的一個 Workflow 工具，協助使用者管理與控制一系列任務的執行，<br>同時提供一個簡潔的UI介面觀看每一個任務的執行狀況、順序、結果與 log。<br>由於 Workflow 本身是一個 CRD，因此建立 workflow 的方法也是透過撰寫一個 yaml 檔，而 Argo 也針對如何描述一個 workflow 提供了許多的規則。</p>
<h2 id="部署Argo"><a href="#部署Argo" class="headerlink" title="部署Argo"></a>部署Argo</h2><p>我們這邊是獨立部署，如果是直接安裝Kubeflow，以下這些components已經安裝完畢，只需另外安裝argo client即可。</p>
<ol>
<li><p>首先下載安裝Argo client<br> Mac:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install argoproj/tap/argo</span><br></pre></td></tr></table></figure>
<p> Linux:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL -o /usr/local/bin/argo https://github.com/argoproj/argo/releases/download/v2.2.1/argo-linux-amd64</span><br><span class="line">chmod +x /usr/local/bin/argo</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下來安裝Argo Controller 與 UI</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns argo</span><br><span class="line">kubectl apply -n argo -f https://raw.githubusercontent.com/argoproj/argo/v2.2.1/manifests/install.yaml</span><br></pre></td></tr></table></figure>
<p> <strong>NOTE: 因為上面的insall.yaml會需要在你的k8s中創建clusterrole。因此如果使用的是GKE，這邊需要特別開通權限。</strong></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding YOURNAME-cluster-admin-binding --clusterrole=cluster-admin --user=YOUREMAIL@gmail.com</span><br></pre></td></tr></table></figure>
<p> 安裝好後就會在k8s下面的argo namespace看到以下的components</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">NAME                         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deploy/argo-ui               1         1         1            1           84d</span><br><span class="line">deploy/workflow-controller   1         1         1            1           84d</span><br><span class="line"></span><br><span class="line">NAME                               DESIRED   CURRENT   READY     AGE</span><br><span class="line">rs/argo-ui-65bb8cf7f6              1         1         1         35s</span><br><span class="line">rs/argo-ui-6bb9c4485f              0         0         0         84d</span><br><span class="line">rs/workflow-controller-7f4dd6bd9   0         0         0         84d</span><br><span class="line">rs/workflow-controller-8fb5fb5d5   1         1         1         33s</span><br><span class="line"></span><br><span class="line">NAME                                     READY     STATUS        RESTARTS   AGE</span><br><span class="line">po/argo-ui-65bb8cf7f6-q2r59              1/1       Running       0          35s</span><br><span class="line">po/argo-ui-6bb9c4485f-7v2d5              1/1       Terminating   0          42d</span><br><span class="line">po/workflow-controller-8fb5fb5d5-spq99   1/1       Running       0          33s</span><br><span class="line"></span><br><span class="line">NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">svc/argo-ui   ClusterIP   10.27.255.240   &lt;none&gt;        80/TCP    84d</span><br></pre></td></tr></table></figure>
</li>
<li><p>在接下來使用Argo的過程中，default account的權限會限制一些功能，因此我們這邊在default account綁上admin privileges。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create rolebinding default-admin --clusterrole=admin --serviceaccount=default:default</span><br></pre></td></tr></table></figure>
<p> 也可以在執行的workflow時指定使用的是哪一個service account</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">argo submit --serviceaccount &lt;name&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>以上即完成Argo的部署。</p>
<h2 id="使用Argo-UI"><a href="#使用Argo-UI" class="headerlink" title="使用Argo UI"></a>使用Argo UI</h2><p>Argo UI 可以讓使用者輕鬆關觀察一個 workflow 的狀況，並檢查每一個步驟的結果與錯誤訊息。</p>
<p><strong>kubectl port-forward</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n argo port-forward deployment/argo-ui 8001:8001</span><br></pre></td></tr></table></figure></p>
<p>透過 <a href="http://127.0.0.1:8001" target="_blank" rel="noopener">http://127.0.0.1:8001</a> 使用</p>
<p><strong>Method 2: kubectl proxy</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy</span><br></pre></td></tr></table></figure></p>
<p>透過  <a href="http://127.0.0.1:8001/api/v1/namespaces/argo/services/argo-ui/proxy/" target="_blank" rel="noopener">http://127.0.0.1:8001/api/v1/namespaces/argo/services/argo-ui/proxy/</a> 使用</p>
<p><strong>Expose a LoadBalancer</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch svc argo-ui -n argo -p &apos;&#123;&quot;spec&quot;: &#123;&quot;type&quot;: &quot;LoadBalancer&quot;&#125;&#125;&apos;</span><br><span class="line"></span><br><span class="line">kubectl get svc argo-ui -n argo</span><br><span class="line">NAME      TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)        AGE</span><br><span class="line">argo-ui   LoadBalancer   10.19.255.205   35.197.49.167   80:30999/TCP   1m</span><br></pre></td></tr></table></figure></p>
<p>結果如下圖：</p>
<p><img src="/images/argo-ui.png" alt="argo-ui"></p>
<h2 id="Argo-範例與解析"><a href="#Argo-範例與解析" class="headerlink" title="Argo 範例與解析"></a>Argo 範例與解析</h2><p>如同上面所說，Argo 也是透過自己實作一個 operator(CRD + controller) 來完成 Workflow 的功能。而所謂的在 k8s 中執行 workflow 的意思便是利用一個個 pod 來執行我們的每一個步驟。</p>
<p>因此我們這邊先來看幾個簡單的 argo crd，看看我們能設定哪些參數及能做到哪些事情。</p>
<p>首先提供一些常用的指令:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">argo list #查看有哪些 workflow</span><br><span class="line">argo get xxx-workflow-name-xxx #查看這個 workflow 的狀態</span><br><span class="line">argo logs xxx-pod-name-xxx #查看這個 pod 的 output</span><br></pre></td></tr></table></figure></p>
<h3 id="coinflip"><a href="#coinflip" class="headerlink" title="coinflip"></a>coinflip</h3><p>這個範例的目標是，先丟一個硬幣，如果是 head 就執行 head 的工作，如果是 tail 就執行 tail 的工作。也就是 workflow 最基礎的 if-else 功能。</p>
<p>首先先利用以下指令來執行coinflip worklow：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">argo submit --watch https://raw.githubusercontent.com/argoproj/argo/master/examples/coinflip.yaml</span><br></pre></td></tr></table></figure></p>
<p>接著我們來分析中間發生了哪些事：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Name:                coinflip-czw7h</span><br><span class="line">Namespace:           default</span><br><span class="line">ServiceAccount:      default</span><br><span class="line">Status:              Succeeded</span><br><span class="line">Created:             Wed Feb 06 23:07:02 +0100 (38 seconds ago)</span><br><span class="line">Started:             Wed Feb 06 23:07:02 +0100 (38 seconds ago)</span><br><span class="line">Finished:            Wed Feb 06 23:07:40 +0100 (now)</span><br><span class="line">Duration:            38 seconds</span><br><span class="line"></span><br><span class="line">STEP               PODNAME                    DURATION  MESSAGE</span><br><span class="line"> ✔ coinflip-czw7h</span><br><span class="line"> ├---✔ flip-coin   coinflip-czw7h-3048772414  23s</span><br><span class="line"> └-·-○ heads                                            when &apos;tails == heads&apos; evaluated false</span><br><span class="line">   └-✔ tails       coinflip-czw7h-3790732747  13s</span><br></pre></td></tr></table></figure>
<p>這是你會看到的介面。上面呈現了一些基本的訊息，以及這個 workflow 每一個 steps 發生的事情與執行了哪個相對應得 pod。</p>
<p>因此問題便是，我們如何讓每一個 pod 知道上一步驟的結果，與如何傳遞結果給下一個步驟。</p>
<p>我們現在來細看這個coinflips到底怎麼做的，以下是他的yaml file：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: Workflow</span><br><span class="line">metadata:</span><br><span class="line">  generateName: coinflip-</span><br><span class="line">spec:</span><br><span class="line">  entrypoint: coinflip</span><br><span class="line">  templates:</span><br><span class="line">  - name: coinflip</span><br><span class="line">    steps:</span><br><span class="line">    - - name: flip-coin</span><br><span class="line">        template: flip-coin</span><br><span class="line">    - - name: heads</span><br><span class="line">        template: heads</span><br><span class="line">        when: &quot;&#123;&#123;steps.flip-coin.outputs.result&#125;&#125; == heads&quot;</span><br><span class="line">      - name: tails</span><br><span class="line">        template: tails</span><br><span class="line">        when: &quot;&#123;&#123;steps.flip-coin.outputs.result&#125;&#125; == tails&quot;</span><br><span class="line"></span><br><span class="line">  - name: flip-coin</span><br><span class="line">    script:</span><br><span class="line">      image: python:alpine3.6</span><br><span class="line">      command: [python]</span><br><span class="line">      source: |</span><br><span class="line">        import random</span><br><span class="line">        result = &quot;heads&quot; if random.randint(0,1) == 0 else &quot;tails&quot;</span><br><span class="line">        print(result)</span><br><span class="line"></span><br><span class="line">  - name: heads</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.6</span><br><span class="line">      command: [sh, -c]</span><br><span class="line">      args: [&quot;echo \&quot;it was heads\&quot;&quot;]</span><br><span class="line"></span><br><span class="line">  - name: tails</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.6</span><br><span class="line">      command: [sh, -c]</span><br><span class="line">      args: [&quot;echo \&quot;it was tails\&quot;&quot;]</span><br></pre></td></tr></table></figure>
<p>從上面可以很簡單知道：</p>
<ul>
<li><code>apiVersion: argoproj.io/v1alpha1</code> 與 <code>kind: Workflow</code> 說明了這是一個CRD</li>
<li><code>spec</code> 從 <code>entrypoing</code> 開始執行，在這邊即是從 <code>coinflip</code> 這個 <code>template</code> 開始</li>
<li><code>templates</code> 裡面的每一項描述的都是一個工作，包含<ul>
<li>名字</li>
<li>可以執行一個 <code>container</code> 或是執行 <code>script</code></li>
<li>container <code>image</code></li>
<li><code>command</code> 與 <code>args</code></li>
<li><code>steps</code> : 作用是排定一系列 <code>templates</code> 執行的先後順序</li>
</ul>
</li>
<li>coinflip 同時作為一個 <code>entrypoint</code> ，特別可以看到他裡面描述的是 <code>steps</code> ，且包含：<ul>
<li>每一步驟的名字</li>
<li>要執行的 <code>template</code></li>
<li>什麼時候執行</li>
</ul>
</li>
</ul>
<p>將上面的 yaml 轉成 json 可以視為[[flip-coin], [heads, tails]]，因此會先執行 flip-coin。而 flip-coin 透過執行的 <code>script</code> 會有一個 result 作為 output，表示擲出硬幣的結果。<br>而下面的步驟透過 <code>NaN</code> 來獲得特定步驟的 output 作為判斷的依據，進而可以達成 if-else 的workflow效果 。</p>
<p>Ref: 可另外參考 <a href="https://raw.githubusercontent.com/argoproj/argo/master/examples/coinflip-recursive.yaml" target="_blank" rel="noopener">coinflip-recursive</a></p>
<h3 id="dag-diamond"><a href="#dag-diamond" class="headerlink" title="dag-diamond"></a>dag-diamond</h3><p>在一個 workflow 中除了 <code>if-else</code> 外，有時也需要能夠表達工作之間的相依性，或是有時一些工作需要可以平行執行。而 Argo 便提供 <code>dag</code> 來描述工作的相依性，直接看範例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: Workflow</span><br><span class="line">metadata:</span><br><span class="line">  generateName: dag-diamond-</span><br><span class="line">spec:</span><br><span class="line">  entrypoint: diamond</span><br><span class="line">  templates:</span><br><span class="line">  - name: diamond</span><br><span class="line">    dag:</span><br><span class="line">      tasks:</span><br><span class="line">      - name: A</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: A&#125;]</span><br><span class="line">      - name: B</span><br><span class="line">        dependencies: [A]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: B&#125;]</span><br><span class="line">      - name: C</span><br><span class="line">        dependencies: [A]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: C&#125;]</span><br><span class="line">      - name: D</span><br><span class="line">        dependencies: [B, C]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: D&#125;]</span><br><span class="line"></span><br><span class="line">  - name: echo</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">      - name: message</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.7</span><br><span class="line">      command: [echo, &quot;&#123;&#123;inputs.parameters.message&#125;&#125;&quot;]</span><br></pre></td></tr></table></figure>
<p>可以注意到這邊沒有使用<code>steps</code>，而是使用<code>dag</code>。在<code>dag</code>中的每一項步驟皆可以使用<code>dependencies</code>來描述相依的工作，比方說 B,C 步驟便強迫要在 A 完成後才能執行。而當 A 完成後，B,C 滿足條件便會同時（平行）執行，最後才交由 D 執行。</p>
<p>透過 <code>dag</code> 便可以編排出工作的順序與相依性，或是讓工作平行執行。</p>
<h4 id="dag-與-steps"><a href="#dag-與-steps" class="headerlink" title="dag 與 steps"></a>dag 與 steps</h4><p>還記得剛剛的 flip-coin 範例嗎，透過steps也可以達成某程度的平行執行或是順序執行，但是無法表達相依性。什麼意思呢？</p>
<p>熟悉 yaml 的人應該會知道 yaml 跟 json 是等價可以互相轉換的，而 yaml 中的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">steps:</span><br><span class="line">    - - name: flip-coin</span><br><span class="line">        template: flip-coin</span><br><span class="line">    - - name: heads</span><br><span class="line">        template: heads</span><br><span class="line">        when: &quot;&#123;&#123;steps.flip-coin.outputs.result&#125;&#125; == heads&quot;</span><br><span class="line">      - name: tails</span><br><span class="line">        template: tails</span><br><span class="line">        when: &quot;&#123;&#123;steps.flip-coin.outputs.result&#125;&#125; == tails&quot;</span><br></pre></td></tr></table></figure>
<p>中間的 <code>- -</code> 表達的是 <em>list中的list</em> 的意思，也就是 [[flip-coin], [heads, tails]]。當 steps 再寫的時候如果是依序執行一律用<code>- -</code>，若是在同一個 list 內則會平行執行。</p>
<p>因此以下用一個例子比較：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  entrypoint: diamond</span><br><span class="line">  templates:</span><br><span class="line">  - name: diamond</span><br><span class="line">    steps:</span><br><span class="line">    - - name: A</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: A&#125;]</span><br><span class="line">    - - name: B</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: B&#125;]</span><br><span class="line">      - name: C</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: C&#125;]</span><br><span class="line">    - - name: D</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: D&#125;]</span><br><span class="line"></span><br><span class="line">  - name: echo</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">      - name: message</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.7</span><br><span class="line">      command: [echo, &quot;&#123;&#123;inputs.parameters.message&#125;&#125;&quot;]</span><br></pre></td></tr></table></figure></p>
<p>是等價於<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">spec:</span><br><span class="line">  entrypoint: diamond</span><br><span class="line">  templates:</span><br><span class="line">  - name: diamond</span><br><span class="line">    dag:</span><br><span class="line">      tasks:</span><br><span class="line">      - name: A</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: A&#125;]</span><br><span class="line">      - name: B</span><br><span class="line">        dependencies: [A]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: B&#125;]</span><br><span class="line">      - name: C</span><br><span class="line">        dependencies: [A]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: C&#125;]</span><br><span class="line">      - name: D</span><br><span class="line">        dependencies: [B, C]</span><br><span class="line">        template: echo</span><br><span class="line">        arguments:</span><br><span class="line">          parameters: [&#123;name: message, value: D&#125;]</span><br><span class="line"></span><br><span class="line">  - name: echo</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">      - name: message</span><br><span class="line">    container:</span><br><span class="line">      image: alpine:3.7</span><br><span class="line">      command: [echo, &quot;&#123;&#123;inputs.parameters.message&#125;&#125;&quot;]</span><br></pre></td></tr></table></figure></p>
<p>如下圖透過UI看到的結果：</p>
<p><img src="/images/dag-steps-cmp.png" alt="dag-steps-cmp"></p>
<h3 id="conditionals"><a href="#conditionals" class="headerlink" title="conditionals"></a>conditionals</h3><p>了解了上面如何實現 <code>if-else</code> ,<code>依序執行</code>, <code>同時執行</code>後，最後在看一個範例解釋了如何在 workflow 執行時動態的給予參數，並影響結果，我們直接看yaml file：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: argoproj.io/v1alpha1</span><br><span class="line">kind: Workflow</span><br><span class="line">metadata:</span><br><span class="line">  generateName: conditional-</span><br><span class="line">spec:</span><br><span class="line">  entrypoint: conditional-example</span><br><span class="line">  arguments:</span><br><span class="line">    parameters:</span><br><span class="line">    - name: should-print</span><br><span class="line">      value: &quot;false&quot;</span><br><span class="line"></span><br><span class="line">  templates:</span><br><span class="line">  - name: conditional-example</span><br><span class="line">    inputs:</span><br><span class="line">      parameters:</span><br><span class="line">      - name: should-print</span><br><span class="line">    steps:</span><br><span class="line">    - - name: print-hello</span><br><span class="line">        template: whalesay</span><br><span class="line">        when: &quot;&#123;&#123;inputs.parameters.should-print&#125;&#125; == true&quot;</span><br><span class="line"></span><br><span class="line">  - name: whalesay</span><br><span class="line">    container:</span><br><span class="line">      image: docker/whalesay:latest</span><br><span class="line">      command: [sh, -c]</span><br><span class="line">      args: [&quot;cowsay hello&quot;]</span><br></pre></td></tr></table></figure>
<p>在 <code>spec</code> 中可以提供 <code>arguments</code> ，來將參數傳進各個<code>step</code> 中。如上面的範例，預設的參數 <code>should-print</code> 為 “false” 而使得直接執行不會執行 whalesay 步驟，但是在執行 workflow 時使用如下指令，便可以動態傳進參數:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">argo submit examples/conditionals.yaml -p should-print=true</span><br></pre></td></tr></table></figure>
<p>而 <code>step</code> 可以使用 <code>NaN</code> 來獲取參數，whalesay這個步驟便會執行。</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>以上便是 Argo 的簡易使用分享，想了解更詳細的使用方法建議直接參考 <a href="https://github.com/argoproj/argo/tree/master/examples" target="_blank" rel="noopener">example</a> 來找到最適合自己的範例。<br>透過 Argo 我們便可以描述 pod 跟 pod 之間的執行順序關係，還可以在彼此之間傳遞結果。<br>因此 <a href="https://github.com/kubeflow/pipelines" target="_blank" rel="noopener">Kubeflow/pipeline</a> 甚至是 Kubeflow 社群的 CI/CD 皆是利用 Argo來完成的。</p>
<p>接下來會利用我自己為 <a href="https://github.com/kubeflow/tf-operator" target="_blank" rel="noopener">Kubeflow/tf-operator</a> 貢獻的 <a href="https://github.com/kubeflow/tf-operator/commit/2788b4d245be919a22b63383441059fc8405ba4e" target="_blank" rel="noopener">e2e test </a> 來描述 Kubeflow 如何用 Argo 實作自己的 CI/CD。</p>

    </div>

    
    
    
        
      

      <footer class="post-footer">
          
            
          
          <div class="post-tags">
            
              <a href="/tags/Kubeflow/" rel="tag"># Kubeflow</a>
            
              <a href="/tags/Kubernetes/" rel="tag"># Kubernetes</a>
            
              <a href="/tags/Workflow/" rel="tag"># Workflow</a>
            
              <a href="/tags/argo/" rel="tag"># argo</a>
            
          </div>
        

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/OpenStack-oslo-config.html" rel="next" title="OpenStack_oslo_config">
                  <i class="fa fa-chevron-left"></i> OpenStack_oslo_config
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/kubeflow-istio-authnz.html" rel="prev" title="Kubeflow如何搭配Istio實作Multi-user認證與權限管理(上)">
                  Kubeflow如何搭配Istio實作Multi-user認證與權限管理(上) <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          
    
    
  <div class="comments" id="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  
  

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#部署Argo"><span class="nav-number">1.</span> <span class="nav-text">部署Argo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用Argo-UI"><span class="nav-number">2.</span> <span class="nav-text">使用Argo UI</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Argo-範例與解析"><span class="nav-number">3.</span> <span class="nav-text">Argo 範例與解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#coinflip"><span class="nav-number">3.1.</span> <span class="nav-text">coinflip</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dag-diamond"><span class="nav-number">3.2.</span> <span class="nav-text">dag-diamond</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#dag-與-steps"><span class="nav-number">3.2.1.</span> <span class="nav-text">dag 與 steps</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#conditionals"><span class="nav-number">3.3.</span> <span class="nav-text">conditionals</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Summary"><span class="nav-number">3.4.</span> <span class="nav-text">Summary</span></a></li></ol></li></ol></div>
        
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" src="/images/me.jpg" alt="Jack Lin">
  <p class="site-author-name" itemprop="name">Jack Lin</p>
  <div class="site-description" itemprop="description">目前任職於 InfuseAI. 專注於Kubeflow與Kubernetes. 同時也是 Kubeflow member與Kubeflow/tf-operator reviewer.</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives">
        
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">tags</span>
        </a>
      </div>
    
  </nav>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
      
        
      
        <a href="https://github.com/ChanYiLin" title="GitHub &rarr; https://github.com/ChanYiLin" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i></a>
      </span>
    
      <span class="links-of-author-item">
      
      
      
        
      
        <a href="https://www.linkedin.com/in/jack-lin-a43506a2/" title="Linkedin &rarr; https://www.linkedin.com/in/jack-lin-a43506a2/" rel="noopener" target="_blank"><i class="fa fa-fw fa-linkedin"></i></a>
      </span>
    
      <span class="links-of-author-item">
      
      
      
        
      
        <a href="https://www.facebook.com/yourname" title="FB Page &rarr; https://www.facebook.com/yourname" rel="noopener" target="_blank"><i class="fa fa-fw fa-facebook"></i></a>
      </span>
    
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jack Lin</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.4.0</div>

        












        
      </div>
    </footer>
  </div>

  


  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/muse.js?v=7.4.0"></script>
<script src="/js/next-boot.js?v=7.4.0"></script>



  





















  

  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://jacklinblog-1.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  function disqus_config() {
    this.page.url = "https://chanyilin.github.io/argo.html";
    this.page.identifier = "argo.html";
    this.page.title = 'Argo';};
  function loadComments() {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://jacklinblog-1.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  }
    window.addEventListener('load', loadComments, false);
  
</script>

</body>
</html>
